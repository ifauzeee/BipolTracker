<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#BF1E2E">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/images/pwa-icon-192.png">
    <link rel="manifest" href="/manifest.json">
    <title>Bipol Tracker</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>

<body>
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <img src="/images/favicon.png" alt="Bipol" class="loading-logo">
            <h2 class="loading-title">Bipol Tracker</h2>
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
            </div>
            <p class="loading-text">Memuat peta...</p>
        </div>
    </div>

    <a href="#bus-list" class="skip-link">Skip to content</a>

    <div class="offline-indicator" id="offline-indicator">
        <i class="fa-solid fa-wifi"></i>
        <span>Mode Offline - Menampilkan data tersimpan</span>
    </div>

    <div id="map" role="application" aria-label="Peta pelacakan bus"></div>

    <div class="floating-controls">
        <a href="/admin" class="fab-btn admin-btn" title="Admin Panel" aria-label="Admin Panel">
            <i class="fa-solid fa-user-shield"></i>
        </a>
    </div>

    <div class="bottom-sheet">
        <div class="sheet-handle-bar">
            <div class="sheet-handle"></div>
        </div>
        <div class="sheet-header">
            <div class="header-text" style="display:flex; justify-content:space-between; align-items:center;">
                <div style="flex:1;">
                    <h1 style="display:flex; align-items:center; gap:8px;">Bipol Tracker<span
                            class="live-badge">LIVE</span></h1>
                    <div class="dashboard-routes" style="display:flex; gap:8px; margin-top:2px;">
                        <button class="chip-dashboard pagi active-route" onclick="toggleRoute('rutePagi', this)">
                            <i class="fa-solid fa-sun"></i> Pagi
                        </button>
                        <button class="chip-dashboard sore active-route" onclick="toggleRoute('ruteSore', this)">
                            <i class="fa-solid fa-cloud-moon"></i> Sore
                        </button>
                    </div>
                </div>
                <div style="display:flex; gap:8px;">
                    <button id="toggleSheetBtn" class="fab-btn" title="Toggle Dashboard" aria-label="Toggle Dashboard"
                        style="width:36px; height:36px; box-shadow:none; border:1px solid rgba(0,0,0,0.1);"><i
                            class="fa-solid fa-chevron-down"></i></button>
                    <button id="recenterBtn" class="fab-btn" title="Reset Lokasi" aria-label="Reset Lokasi"
                        style="width:36px; height:36px; box-shadow:none; border:1px solid rgba(0,0,0,0.1);"><i
                            class="fa-solid fa-location-crosshairs"></i></button>
                </div>
            </div>
        </div>
        <div class="sheet-content">
            <h3>Armada Aktif</h3>
            <div id="bus-list">
                <div class="skeleton-loader hidden" id="skeleton-loader">
                    <div class="skeleton-item"></div>
                    <div class="skeleton-item"></div>
                    <div class="skeleton-item"></div>
                </div>
                <div class="empty-state" id="empty-state">
                    <i class="fa-solid fa-satellite-dish fa-spin"></i>
                    <p>Mencari sinyal satelit...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="info-page" class="page-view">
        <div class="page-header">
            <h2><i class="fa-solid fa-bullhorn"></i> Info & Pengumuman</h2>
        </div>
        <div class="page-content" id="dynamic-info-list">
        </div>
    </div>

    <div id="faq-page" class="page-view">
        <div class="page-header">
            <h2><i class="fa-solid fa-circle-question"></i> FAQ & Panduan</h2>
        </div>
        <div class="page-content faq-content">
            <div class="faq-intro">
                <p>Selamat datang di Bipol Tracker! Berikut penjelasan fitur-fitur yang tersedia di aplikasi ini.</p>
            </div>

            <div class="faq-section">
                <h3><i class="fa-solid fa-bus"></i> Status Armada</h3>

                <div class="faq-item">
                    <div class="faq-icon status-green"><i class="fa-solid fa-bus"></i></div>
                    <div class="faq-text">
                        <h4>Berjalan <span class="status-dot dot-green"></span></h4>
                        <p>Bus sedang bergerak dengan kecepatan lebih dari 0 km/h. Status ini menunjukkan armada aktif
                            beroperasi di jalur.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-icon status-yellow"><i class="fa-solid fa-circle-pause"></i></div>
                    <div class="faq-text">
                        <h4>Berhenti <span class="status-dot dot-yellow"></span></h4>
                        <p>Bus berhenti sementara (kecepatan 0 km/h) kurang dari 5 menit. Kemungkinan sedang
                            menurunkan/menaikkan penumpang atau berhenti di lampu merah.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-icon status-gray"><i class="fa-solid fa-square-parking"></i></div>
                    <div class="faq-text">
                        <h4>Parkir <span class="status-dot dot-gray"></span></h4>
                        <p>Bus sudah berhenti lebih dari 5 menit. Kemungkinan sedang parkir, istirahat, atau tidak
                            beroperasi.</p>
                    </div>
                </div>

                <div class="faq-item">
                    <div class="faq-icon status-red"><i class="fa-solid fa-triangle-exclamation"></i></div>
                    <div class="faq-text">
                        <h4>Gas Tinggi <span class="status-dot dot-red"></span></h4>
                        <p>Sensor mendeteksi kadar gas berbahaya di dalam bus melebihi batas aman (>600). Segera periksa
                            kondisi armada!</p>
                    </div>
                </div>
            </div>

            <div class="faq-section">
                <h3><i class="fa-solid fa-clock"></i> Estimasi Waktu (ETA)</h3>
                <div class="faq-item">
                    <div class="faq-icon status-blue"><i class="fa-solid fa-location-dot"></i></div>
                    <div class="faq-text">
                        <h4>Perkiraan Tiba</h4>
                        <p>Menampilkan estimasi waktu bus tiba di halte terdekat berdasarkan jarak dan kecepatan saat
                            ini. Contoh: "5 min ke Halte PNJ".</p>
                    </div>
                </div>
            </div>

            <div class="faq-section">
                <h3><i class="fa-solid fa-route"></i> Fitur Rute</h3>
                <div class="faq-item">
                    <div class="faq-icon status-orange"><i class="fa-solid fa-sun"></i></div>
                    <div class="faq-text">
                        <h4>Rute Pagi (06:30 - 10:00)</h4>
                        <p>Jalur keberangkatan pagi dari terminal ke kampus PNJ. Aktifkan untuk melihat rute di peta.
                        </p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-icon status-purple"><i class="fa-solid fa-cloud-moon"></i></div>
                    <div class="faq-text">
                        <h4>Rute Sore (14:00 - 18:00)</h4>
                        <p>Jalur kepulangan sore dari kampus PNJ ke terminal. Aktifkan untuk melihat rute di peta.</p>
                    </div>
                </div>
            </div>

            <div class="faq-section">
                <h3><i class="fa-solid fa-gauge"></i> Informasi Sensor</h3>
                <div class="faq-item">
                    <div class="faq-icon status-blue"><i class="fa-solid fa-gauge"></i></div>
                    <div class="faq-text">
                        <h4>Kecepatan (Speed)</h4>
                        <p>Kecepatan bus dalam satuan km/jam yang diambil dari GPS tracker.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-icon status-red"><i class="fa-solid fa-fire"></i></div>
                    <div class="faq-text">
                        <h4>Level Gas</h4>
                        <p>Nilai sensor gas di dalam bus. Nilai di atas 600 dianggap berbahaya dan akan memicu
                            peringatan.</p>
                    </div>
                </div>
            </div>

            <div class="faq-section">
                <h3><i class="fa-solid fa-map"></i> Penggunaan Peta</h3>
                <div class="faq-item">
                    <div class="faq-icon status-blue"><i class="fa-solid fa-hand-pointer"></i></div>
                    <div class="faq-text">
                        <h4>Klik Bus di Daftar</h4>
                        <p>Klik item bus di daftar armada untuk fokus dan mengikuti pergerakan bus tersebut di peta.</p>
                    </div>
                </div>
                <div class="faq-item">
                    <div class="faq-icon status-gray"><i class="fa-solid fa-location-crosshairs"></i></div>
                    <div class="faq-text">
                        <h4>Tombol Reset Lokasi</h4>
                        <p>Klik tombol ini untuk mengembalikan tampilan peta ke posisi default dan berhenti mengikuti
                            bus.</p>
                    </div>
                </div>
            </div>

            <div class="faq-section lost-items-section">
                <h3><i class="fa-solid fa-box-open"></i> Barang Ketinggalan</h3>
                <div class="lost-items-intro">
                    <p><i class="fa-solid fa-info-circle"></i> Kehilangan barang di bus? Isi form di bawah ini dan kami
                        akan membantu mencarikan barang Anda.</p>
                </div>
                <form id="lostItemForm" class="lost-item-form" onsubmit="submitLostItem(event)">
                    <div class="form-group">
                        <label for="busPlate"><i class="fa-solid fa-bus"></i> Nomor Plat Bus</label>
                        <input type="text" id="busPlate" name="busPlate" placeholder="Contoh: B 1234 ABC" required>
                    </div>
                    <div class="form-group">
                        <label for="waNumber"><i class="fa-brands fa-whatsapp"></i> Nomor WhatsApp Anda</label>
                        <input type="tel" id="waNumber" name="waNumber" placeholder="Contoh: 08123456789" required
                            pattern="[0-9]+" inputmode="numeric"
                            oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                    </div>
                    <div class="form-group">
                        <label for="lostMessage"><i class="fa-solid fa-message"></i> Deskripsi Barang</label>
                        <textarea id="lostMessage" name="lostMessage" rows="4"
                            placeholder="Jelaskan barang yang hilang, ciri-ciri, dan lokasi terakhir Anda melihatnya..."
                            required></textarea>
                    </div>
                    <button type="submit" class="btn-submit-lost">
                        <i class="fa-solid fa-paper-plane"></i> Kirim Laporan
                    </button>
                </form>
            </div>

            <div class="faq-section feedback-section"
                style="margin-top: 30px; border-top: 2px dashed #e2e8f0; padding-top: 30px;">
                <h3><i class="fa-solid fa-bug"></i> Lapor Bug & Saran</h3>
                <div class="lost-items-intro" style="background: #f8fafc; border: 1px solid #e2e8f0;">
                    <p style="color: #475569;"><i class="fa-solid fa-code" style="color:#64748b;"></i> Web ini masih
                        dalam pengembangan. Jika menemukan bug sekecil apapun atau punya saran fitur, jangan sungkan
                        lapor di sini.</p>
                </div>
                <form id="feedbackForm" class="lost-item-form" onsubmit="submitFeedback(event)">
                    <div class="form-group">
                        <label><i class="fa-regular fa-user"></i> Nama (Opsional)</label>
                        <input type="text" name="name" placeholder="Nama Anda (Boleh kosong)">
                    </div>
                    <div class="form-group">
                        <label><i class="fa-solid fa-comment-dots"></i> Detail Masukan</label>
                        <textarea name="message" rows="4" required
                            placeholder="Ceritakan bug yang Anda temukan atau fitur yang Anda inginkan..."></textarea>
                    </div>
                    <button type="submit" class="btn-submit-lost" style="background:#475569;">
                        <i class="fa-solid fa-paper-plane"></i> Kirim Masukan
                    </button>
                </form>
            </div>

            <div class="faq-footer-cta" style="margin-top:60px; text-align:center; padding:50px 20px 80px 20px;">
                <h2
                    style="font-size:1.4rem; line-height:1.2; color:#334155; font-weight:800; letter-spacing:1px; margin-bottom:15px; text-transform:uppercase; font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif;">
                    INGIN MENJADI BAGIAN DARI<br>
                    <span
                        style="color:#f59e0b; display:block; font-size:2.4rem; margin-top:8px; text-shadow:2px 2px 0px rgba(245, 158, 11, 0.15); letter-spacing:-1px; font-weight:900;">TEAM
                        PEJUANG BIPOL?</span>
                </h2>
                <div style="font-size:1rem; color:#64748b; margin-bottom:35px; letter-spacing:2px; font-weight:600;">
                    SILAHKAN HUBUNGI</div>

                <a href="mailto:bipoltracker.tik@gmail.com?subject=Join Team Pejuang Bipol"
                    style="text-decoration:none; display:inline-flex; align-items:center; gap:12px; background:#ea4335; color:white; padding:16px 32px; border-radius:100px; font-weight:800; font-size:1.1rem; box-shadow:0 8px 25px rgba(234, 67, 53, 0.35); transition:all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); letter-spacing:0.5px;"
                    onmouseover="this.style.transform='scale(1.05) translateY(-3px)'; this.style.boxShadow='0 15px 30px rgba(234, 67, 53, 0.45)'"
                    onmouseout="this.style.transform='scale(1) translateY(0)'; this.style.boxShadow='0 8px 25px rgba(234, 67, 53, 0.35)'">
                    <i class="fa-brands fa-google" style="font-size:1.3rem;"></i> HUBUNGI VIA GMAIL
                </a>
            </div>
        </div>
    </div>

    <div id="route-view" class="page-view">
        <div class="route-panel-overlay" onclick="if(event.target === this) switchTab('home')">
            <div class="route-master-panel">
                <div class="panel-header">
                    <div class="header-content">
                        <h2><i class="fa-solid fa-route"></i> Pilih Rute</h2>
                        <p>Aktifkan rute untuk melihat jalur di peta</p>
                    </div>
                    <button class="close-route-btn" onclick="switchTab('home')" aria-label="Tutup Panel Rute"><i
                            class="fa-solid fa-times"></i></button>
                </div>
                <div class="route-list-container">
                    <div class="route-card-item" id="card-rutePagi" onclick="toggleRouteCard('rutePagi')">
                        <div class="route-card-icon morning-theme"><i class="fa-solid fa-sun"></i></div>
                        <div class="route-card-info"><span class="route-name">Rute Pagi</span>
                            <div class="route-meta"><span><i class="fa-regular fa-clock"></i> 06:30 -
                                    10:00</span><span><i class="fa-solid fa-arrow-right"></i> Berangkat</span></div>
                        </div>
                        <div class="route-checkbox">
                            <div class="custom-toggle"></div>
                        </div>
                    </div>
                    <div class="route-card-item" id="card-ruteSore" onclick="toggleRouteCard('ruteSore')">
                        <div class="route-card-icon afternoon-theme"><i class="fa-solid fa-cloud-moon"></i></div>
                        <div class="route-card-info"><span class="route-name">Rute Sore</span>
                            <div class="route-meta"><span><i class="fa-regular fa-clock"></i> 14:00 -
                                    18:00</span><span><i class="fa-solid fa-arrow-left"></i> Pulang</span></div>
                        </div>
                        <div class="route-checkbox">
                            <div class="custom-toggle"></div>
                        </div>
                    </div>
                </div>
                <div class="panel-footer-info">
                    <div class="info-pill"><i class="fa-solid fa-calendar-check"></i><span>Senin - Jumat</span></div>
                    <div class="info-pill"><i class="fa-solid fa-ban"></i><span>Libur Nasional Off</span></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script type="module" src="/js/app.js"></script>

    <div id="image-modal" class="image-modal" onclick="closeImage()">
        <span class="close-modal">&times;</span><img class="modal-content" id="img01">
        <div id="caption"></div>
    </div>

    <nav class="mobile-nav" role="navigation" aria-label="Menu utama">
        <div class="nav-item" onclick="switchTab('announcement')" role="button" tabindex="0"
            aria-label="Info dan Pengumuman">
            <i class="fa-solid fa-bullhorn" aria-hidden="true"></i><span>Info</span>
        </div>
        <div class="nav-item active" onclick="switchTab('home')" role="button" tabindex="0" aria-label="Halaman Utama"
            aria-current="page">
            <i class="fa-solid fa-house" aria-hidden="true"></i><span>Home</span>
        </div>
        <div class="nav-item" onclick="switchTab('faq')" role="button" tabindex="0" aria-label="FAQ dan Panduan">
            <i class="fa-solid fa-circle-question" aria-hidden="true"></i><span>FAQ</span>
        </div>
    </nav>
    <script>if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js');</script>
    <script>
        const RATE_LIMIT_KEY = 'lastLostItemSubmit';
        const RATE_LIMIT_MINUTES = 5;

        async function submitLostItem(event) {
            event.preventDefault();

            const lastSubmit = localStorage.getItem(RATE_LIMIT_KEY);
            const now = Date.now();

            if (lastSubmit) {
                const timePassed = (now - parseInt(lastSubmit)) / 1000 / 60;
                if (timePassed < RATE_LIMIT_MINUTES) {
                    const remaining = Math.ceil(RATE_LIMIT_MINUTES - timePassed);
                    Swal.fire({
                        icon: 'warning',
                        title: 'Mohon Tunggu',
                        html: `Anda baru saja mengirim laporan.<br>Silakan tunggu <b>${remaining} menit</b> lagi untuk mengirim laporan baru.`,
                        confirmButtonColor: '#BF1E2E'
                    });
                    return;
                }
            }

            const busPlate = document.getElementById('busPlate').value.trim();
            const waNumber = document.getElementById('waNumber').value.trim();
            const lostMessage = document.getElementById('lostMessage').value.trim();

            if (!busPlate || !waNumber || !lostMessage) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Form Belum Lengkap',
                    text: 'Mohon isi semua field yang diperlukan',
                    confirmButtonColor: '#BF1E2E'
                });
                return;
            }

            if (!/^[0-9]+$/.test(waNumber)) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Nomor WhatsApp Tidak Valid',
                    text: 'Nomor WhatsApp hanya boleh berisi angka',
                    confirmButtonColor: '#BF1E2E'
                });
                return;
            }

            if (waNumber.length < 10 || waNumber.length > 15) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Nomor WhatsApp Tidak Valid',
                    text: 'Nomor WhatsApp harus 10-15 digit',
                    confirmButtonColor: '#BF1E2E'
                });
                return;
            }

            Swal.fire({
                title: 'Mengirim Laporan...',
                text: 'Mohon tunggu sebentar',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const response = await fetch('/api/lost-items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        bus_plate: busPlate,
                        whatsapp_number: waNumber,
                        message: lostMessage
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Gagal mengirim laporan');
                }

                localStorage.setItem(RATE_LIMIT_KEY, now.toString());

                Swal.fire({
                    icon: 'success',
                    title: 'Laporan Diterima',
                    text: 'Terima kasih! Laporan Anda telah kami terima dan akan segera ditindaklanjuti.',
                    confirmButtonColor: '#10b981'
                });

                document.getElementById('lostItemForm').reset();

            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Mengirim',
                    text: error.message || 'Terjadi kesalahan, silakan coba lagi',
                    confirmButtonColor: '#BF1E2E'
                });
            }
        }

        async function submitFeedback(event) {
            event.preventDefault();
            const form = event.target;
            const btn = form.querySelector('button');
            const originalContent = btn.innerHTML;

            const name = form.name.value.trim() || 'Anonim';
            const messageRaw = form.message.value.trim();

            if (messageRaw.length < 5) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Pesan Terlalu Pendek',
                    text: 'Mohon isi detail masukan minimal 5 karakter.',
                    confirmButtonColor: '#475569'
                });
                return;
            }

            const payload = {
                name: name,
                message: messageRaw
            };

            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Mengirim...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/feedback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Gagal mengirim masukan');
                }

                Swal.fire({
                    icon: 'success',
                    title: 'Masukan Terkirim!',
                    text: 'Terima kasih atas kontribusi Anda dalam pengembangan Bipol Tracker.',
                    confirmButtonColor: '#475569'
                });

                form.reset();

            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Mengirim',
                    text: error.message || 'Terjadi kesalahan jaringan',
                    confirmButtonColor: '#BF1E2E'
                });
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        window.addEventListener('online', () => {
            document.getElementById('offline-indicator').classList.remove('show');
            showToast('Koneksi pulih', 'success');
        });

        window.addEventListener('offline', () => {
            document.getElementById('offline-indicator').classList.add('show');
            showToast('Mode offline aktif', 'warning');
        });

        function showToast(message, type = 'info') {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();

            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            toast.innerHTML = `<i class="fa-solid fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i> ${message}`;
            document.body.appendChild(toast);

            setTimeout(() => toast.remove(), 3000);
        }

        function triggerHaptic() {
            if ('vibrate' in navigator) {
                navigator.vibrate(50);
            }
        }

        if (!navigator.onLine) {
            document.getElementById('offline-indicator').classList.add('show');
        }
    </script>
</body>

</html>