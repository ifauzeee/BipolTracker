import*as w from"https://cdn.jsdelivr.net/npm/@turf/turf@7/+esm";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&o(n)}).observe(document,{childList:!0,subtree:!0});function a(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(t){if(t.ep)return;t.ep=!0;const s=a(t);fetch(t.href,s)}})();const E=[{lng:106.823983,lat:-6.371168,title:"Halte PNJ"},{lng:106.831581,lat:-6.360951,title:"Halte St. UI"},{lng:106.831678,lat:-6.368193,title:"Halte Pondok Cina"},{lng:106.831739,lat:-6.353486,title:"Halte Menwa"}],M=[[106.82442672767823,-6.371652849002165],[106.82406284331717,-6.371666869491176],[106.82400869439084,-6.371629588149347],[106.82397919037493,-6.3713856816309535],[106.82396309736485,-6.371125781310585],[106.82394968631164,-6.370600649527726],[106.82392822882588,-6.370250116860132],[106.82419510857854,-6.370231457453673],[106.82403417601651,-6.366948701129196],[106.82307662740313,-6.366927375783644],[106.82295190468999,-6.366928708593834],[106.82265038025012,-6.366877515581393],[106.82238625718091,-6.366740391778335],[106.8217141232146,-6.366135087934355],[106.8215308140501,-6.365903935986858],[106.82145197141364,-6.365745263799935],[106.8214421159044,-6.365717839207456],[106.8214322606977,-6.365443591093928],[106.82152292950728,-6.365228110451426],[106.82258074355968,-6.361813630190757],[106.82267765903862,-6.36156628675808],[106.82300577227879,-6.360561618247093],[106.82646484915253,-6.349295297042475],[106.82662961097681,-6.348881237733786],[106.82679056241071,-6.348645861184371],[106.82699060247094,-6.348504178797341],[106.82762980989762,-6.3481842494709815],[106.82781145521375,-6.348127118997285],[106.82814715428164,-6.348124834250687],[106.83132063747823,-6.348686589888224],[106.83161265009271,-6.348812276115519],[106.83179664735408,-6.348996564738525],[106.83189526988951,-6.3491492477541085],[106.83194268527521,-6.349399949471629],[106.83191423626853,-6.349586562107233],[106.83154951832383,-6.351188705704311],[106.83154951797322,-6.351352158746319],[106.83169725593977,-6.351778800340975],[106.8318143315671,-6.352011514222904],[106.83192304430808,-6.3524132211112905],[106.83190074442314,-6.353014397092337],[106.83166659344568,-6.354139174955968],[106.8315857556035,-6.354333102237226],[106.83034809932248,-6.355903909292467],[106.83026168792674,-6.356067360251776],[106.83020315015507,-6.356229155723879],[106.83019177056302,-6.35654017224898],[106.830222116269,-6.356738091801801],[106.83027522131749,-6.356883232821711],[106.83039281115632,-6.357058533052631],[106.83116913303435,-6.358062508867046],[106.83121275452656,-6.358205763954129],[106.83183145727551,-6.362196287857281],[106.83188835612688,-6.362686369678626],[106.83196611676709,-6.363206608337798],[106.83214819087186,-6.364137759619623],[106.83218612295519,-6.364463850705876],[106.83219370944018,-6.364786171822743],[106.83213870806277,-6.367655009436075],[106.83210077593748,-6.3678076870555405],[106.83121505931135,-6.368703017072651],[106.83109936601988,-6.368848154853232],[106.83104626118912,-6.369117695630399],[106.83100074261294,-6.36989615967564],[106.83097987993587,-6.370508751524728],[106.8309191884381,-6.370763212744939],[106.83077125307008,-6.371013903735322],[106.8305588327837,-6.371238206455704],[106.82989312322047,-6.371645343487923],[106.82972242824667,-6.3716736168969215],[106.82857118742204,-6.37164157346438],[106.82777650791444,-6.371628379021292],[106.82754701861623,-6.371581257070012],[106.82722649165235,-6.371360724174208],[106.82532988352169,-6.3693231498366885],[106.82509849740109,-6.369027220068561],[106.82502263320343,-6.368752024143348],[106.8249922870877,-6.3685428002266695],[106.82497901093811,-6.367234674795403],[106.82495625163756,-6.367144199176982],[106.82480641967074,-6.367000946073418],[106.82462434540332,-6.366929319410343],[106.82419950519345,-6.366934973541951],[106.8242222638335,-6.367734175163849],[106.82436830225195,-6.370610536458855],[106.82441571783855,-6.370678392243527],[106.82441761492113,-6.371102493717312],[106.82441002835097,-6.371366379045477],[106.82443089088757,-6.371654768165203]],_=[[106.831697,-6.351814],[106.831863,-6.352137],[106.83192,-6.352489],[106.831879,-6.352952],[106.831673,-6.354154],[106.830275,-6.355982],[106.830157,-6.356449],[106.830284,-6.356934],[106.831209,-6.358163],[106.831871,-6.362697],[106.831955,-6.363241],[106.832169,-6.364361],[106.83218,-6.364643],[106.832126,-6.367669],[106.832097,-6.367791],[106.832024,-6.367906],[106.831142,-6.36877],[106.831072,-6.368884],[106.830954,-6.370622],[106.8309,-6.370801],[106.830509,-6.371273],[106.829755,-6.371675],[106.827644,-6.371609],[106.827234,-6.371366],[106.825107,-6.369023],[106.825008,-6.368711],[106.824992,-6.367202],[106.824868,-6.367021],[106.824643,-6.366925],[106.824187,-6.366933],[106.824361,-6.370596],[106.824404,-6.370686],[106.824423,-6.371635],[106.824062,-6.371653],[106.824007,-6.371604],[106.823978,-6.371159],[106.823978,-6.371159],[106.823942,-6.370263],[106.824207,-6.370237],[106.824042,-6.366937],[106.822922,-6.366918],[106.822439,-6.36677],[106.821538,-6.365893],[106.821445,-6.36546],[106.821978,-6.36384],[106.822061,-6.363858],[106.821599,-6.365354],[106.821573,-6.365646],[106.82167,-6.365879],[106.822449,-6.366674],[106.822984,-6.366843],[106.824922,-6.36686],[106.825128,-6.367109],[106.825088,-6.368654],[106.825182,-6.368965],[106.827334,-6.37131],[106.827731,-6.371536],[106.829861,-6.371583],[106.830465,-6.371206],[106.830775,-6.370821],[106.830884,-6.370522],[106.830933,-6.369008],[106.831022,-6.368784],[106.831985,-6.367819],[106.832055,-6.367664],[106.832105,-6.364487],[106.831961,-6.363674],[106.831781,-6.363386],[106.831666,-6.36301],[106.831655,-6.362749],[106.831768,-6.36241],[106.831079,-6.358165],[106.831009,-6.357987],[106.830148,-6.356843],[106.830076,-6.356521],[106.830124,-6.356134],[106.830258,-6.355881],[106.831477,-6.354294],[106.831595,-6.354008],[106.831837,-6.352601],[106.831831,-6.352337],[106.831649,-6.351833],[106.831697,-6.351814]],p=new maplibregl.LngLatBounds;M.forEach(e=>p.extend(e));_.forEach(e=>p.extend(e));function N(e,i,a,o){const s=(a-e)*Math.PI/180,n=(o-i)*Math.PI/180,c=Math.sin(s/2)*Math.sin(s/2)+Math.cos(e*Math.PI/180)*Math.cos(a*Math.PI/180)*Math.sin(n/2)*Math.sin(n/2);return 6371*(2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c)))}function R(e,i){const a=i&&i>5?i:20,o=e/a;return Math.ceil(o*60)}function O(e){if(e<=0)return"Tiba sekarang";if(e===1)return"1 min";if(e>=60){const i=Math.floor(e/60),a=e%60;return`${i} jam ${a} min`}return`${e} min`}const L={};let v=600,$=5;function B(e){e.gasAlertThreshold&&(v=e.gasAlertThreshold),e.busStopTimeoutMinutes&&($=e.busStopTimeoutMinutes)}function S(e){const i=Date.now();if(e.speed>0)return L[e.bus_id]=i,{status:"Berjalan",class:"dot-green",icon:"fa-bus"};if(!L[e.bus_id])return{status:"Parkir",class:"dot-gray",icon:"fa-square-parking"};const a=L[e.bus_id];return(i-a)/1e3/60>=$?{status:"Parkir",class:"dot-gray",icon:"fa-square-parking"}:{status:"Berhenti",class:"dot-yellow",icon:"fa-circle-pause"}}let d,h={},k=[],P=null;function u(){return d}function f(e){P=e}function m(){return P}function q(){Object.values(h).forEach(e=>{const i=e.marker.getPopup();i&&i.remove()})}function F(){return d=new maplibregl.Map({container:"map",style:{version:8,sources:{"google-maps":{type:"raster",tiles:[`https://mt0.google.com/vt/lyrs=m${window.devicePixelRatio>1?"&scale=2":""}&hl=id&x={x}&y={y}&z={z}`,`https://mt1.google.com/vt/lyrs=m${window.devicePixelRatio>1?"&scale=2":""}&hl=id&x={x}&y={y}&z={z}`,`https://mt2.google.com/vt/lyrs=m${window.devicePixelRatio>1?"&scale=2":""}&hl=id&x={x}&y={y}&z={z}`,`https://mt3.google.com/vt/lyrs=m${window.devicePixelRatio>1?"&scale=2":""}&hl=id&x={x}&y={y}&z={z}`],tileSize:256,attribution:"&copy; Google Maps"}},layers:[{id:"google-maps-layer",type:"raster",source:"google-maps",minzoom:0,maxzoom:22}]},bounds:p,maxBounds:[[p.getSouthWest().lng-.05,p.getSouthWest().lat-.05],[p.getNorthEast().lng+.05,p.getNorthEast().lat+.05]],fitBoundsOptions:{padding:{top:40,bottom:window.innerWidth<768?230:150,left:20,right:20}},pitch:0,bearing:0,bearing:0,antialias:!0,maxZoom:18}),d.on("styleimagemissing",e=>{const i=e.id;if(!d.hasImage(i)){const a=new Uint8Array(4);a[0]=0,a[1]=0,a[2]=0,a[3]=0,d.addImage(i,{width:1,height:1,data:a})}}),d.on("error",e=>{e.error&&e.error.message&&e.error.message.includes("Expected value to be of type number, but found null")||console.warn("Map error:",e.error)}),d}function W(){d.getSource("rutePagi")||(d.addSource("rutePagi",{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:M}}}),d.addLayer({id:"rutePagiLayer",type:"line",source:"rutePagi",layout:{"line-join":"round","line-cap":"round",visibility:"visible"},paint:{"line-color":"#BF1E2E","line-width":4,"line-opacity":.9,"line-offset":-3}})),d.getSource("ruteSore")||(d.addSource("ruteSore",{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:_}}}),d.addLayer({id:"ruteSoreLayer",type:"line",source:"ruteSore",layout:{"line-join":"round","line-cap":"round",visibility:"visible"},paint:{"line-color":"#159BB3","line-width":4,"line-opacity":.9,"line-offset":3}})),document.querySelectorAll(".chip").forEach(e=>e.classList.add("active-route"))}function z(e,i){if(!d)return;const a=e+"Layer",o=d.getLayoutProperty(a,"visibility"),t=o==="visible"||o===void 0?"none":"visible";d.setLayoutProperty(a,"visibility",t);const s=t==="visible";if(i&&((i.classList.contains("chip")||i.classList.contains("chip-dashboard"))&&i.classList.toggle("active-route",s),i.classList.contains("route-card-item")&&i.classList.toggle("active-card",s),!i.classList.contains("chip-dashboard"))){const n=i.querySelector("i");n&&(n.className=s?"fa-solid fa-check":"fa-solid fa-xmark")}}typeof window<"u"&&(window.toggleRoute=z);function G(){k.forEach(e=>e.remove()),k=[],E.forEach(e=>{const i=document.createElement("div");i.style.backgroundImage="url('https://png.pngtree.com/png-clipart/20230321/original/pngtree-bus-stop-vector-icon-design-illustration-png-image_8997806.png')",i.style.width="30px",i.style.height="30px",i.style.backgroundSize="contain",i.style.backgroundRepeat="no-repeat";const a=new maplibregl.Marker({element:i}).setLngLat([e.lng,e.lat]).setPopup(new maplibregl.Popup({offset:25}).setText(e.title)).addTo(d);k.push(a)})}function U(){const e=d.getStyle();if(!e||!e.sources)return;const i=Object.keys(e.sources).find(a=>e.sources[a].type==="vector");i&&!d.getLayer("add-3d-buildings")&&d.addLayer({id:"add-3d-buildings",source:i,"source-layer":"building",filter:["all",["has","extrude"],["==",["get","extrude"],"true"]],type:"fill-extrusion",minzoom:14,paint:{"fill-extrusion-color":"#aaa","fill-extrusion-height":["case",["has","render_height"],["to-number",["get","render_height"],0],["has","height"],["to-number",["get","height"],0],0],"fill-extrusion-base":["case",["has","render_min_height"],["to-number",["get","render_min_height"],0],["has","min_height"],["to-number",["get","min_height"],0],0],"fill-extrusion-opacity":.6}})}function A(e){const i=[e.longitude,e.latitude],a=e.gas_level>v?"popup-danger":"",t=S(e).status;let s="status-stopped";t==="Berjalan"?s="status-moving":t==="Berhenti"&&(s="status-paused");let n="";const l=E.map(r=>({...r,dist:N(e.latitude,e.longitude,r.lat,r.lng)})).sort((r,y)=>r.dist-y.dist)[0];if(l&&l.dist<5){const r=R(l.dist,e.speed);n=`
        <div class="popup-eta" style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
            <div style="font-size:0.75rem; color:#6b7280; display:flex; justify-content:space-between; align-items:center;">
                <span>Menuju <b>${l.title.replace("Halte ","")}</b></span>
                <span style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-weight:700;">${O(r)}</span>
            </div>
            <div style="width:100%; height:4px; background:#f3f4f6; border-radius:2px; margin-top:6px; overflow:hidden;">
                <div style="width:${Math.max(10,Math.min(100,(1-l.dist/3)*100))}%; height:100%; background:#0369a1; border-radius:2px;"></div>
            </div>
        </div>`}const g=`
        <div class="bus-popup">
            <div class="popup-header">
                <img src="./images/bipol.png" class="popup-icon">
                <div class="popup-title">
                    <h3>${e.bus_id}</h3>
                    <div style="display:flex; gap:6px; align-items:center;">
                        <span class="popup-status ${s}" style="font-size:0.7rem; padding:2px 6px;">${t}</span>
                    </div>
                </div>
            </div>
            <div class="popup-stats">
                <div class="popup-stat">
                    <i class="fa-solid fa-gauge"></i>
                    <span>${e.speed} km/h</span>
                </div>
                <div class="popup-stat ${a}">
                    <i class="fa-solid fa-fire"></i>
                    <span>${e.gas_level}</span>
                </div>
            </div>
            ${n}
        </div>
    `;if(h[e.bus_id]){const r=h[e.bus_id];r.marker.setLngLat(i),r.marker.getPopup().setHTML(g),m()===e.bus_id&&u()&&u().jumpTo({center:i})}else{const r=document.createElement("div");r.className="bus-marker-icon",r.style.backgroundImage="url(/images/bipol.png)",r.style.width="42px",r.style.height="42px",r.style.backgroundSize="contain",r.style.backgroundRepeat="no-repeat",r.style.cursor="pointer";const y=document.createElement("div");y.className="marker-pulse",r.appendChild(y),r.onclick=()=>{m()!==e.bus_id&&(f(e.bus_id),u().jumpTo({center:i,zoom:17.5}),document.querySelectorAll(".bus-item").forEach(D=>D.classList.remove("active-focus")))};const C=new maplibregl.Marker({element:r}).setLngLat(i).setPopup(new maplibregl.Popup({offset:25}).setHTML(g)).addTo(d);h[e.bus_id]={marker:C}}}function V(e){Object.keys(h).forEach(i=>{e.has(i)||(h[i].remove(),delete h[i])})}let I=0;fetch("/api/config").then(e=>e.json()).then(e=>{B(e)}).catch(()=>{});function J(){document.getElementById("recenterBtn").onclick=()=>{f(null),q(),u().fitBounds(p,{padding:{top:40,bottom:window.innerWidth<768?230:150,left:20,right:20},pitch:0,bearing:0,speed:1.2,curve:1.42,essential:!0}),document.querySelectorAll(".bus-item").forEach(i=>i.classList.remove("active-focus"))},window.toggleRouteCard=i=>{z(i,null)};const e=document.getElementById("toggleSheetBtn");if(e&&e.addEventListener("click",i=>{i.stopPropagation(),document.querySelector(".bottom-sheet").classList.toggle("collapsed")}),window.innerWidth<768){const i=document.querySelector(".bottom-sheet");i&&i.classList.add("collapsed")}}function K(e,i,a){const o=document.createElement("div");o.className="bus-item animate-enter",o.style.animationDelay=`${a*.1}s`,o.id=`bus-item-${e.bus_id}`,m()===e.bus_id&&o.classList.add("active-focus");const t=S(e);let s=t.class;e.gas_level>v&&(s="dot-red");const n=e.gas_level>v?"text-danger":"",c=b(e);o.innerHTML=`
        <div class="bus-icon-wrapper"><img src="./images/bipol.png"></div>
        <div class="bus-info">
            <h4>${e.bus_id} <span class="status-dot ${s}"></span> <span class="eta-inline"><i class="fa-solid ${c.icon}"></i> ${c.text}</span></h4>
            <p><span><i class="fa-solid ${t.icon}"></i> ${t.status}</span> &bull;
            <span><i class="fa-solid fa-gauge"></i> ${e.speed} km/h</span> &bull;
            <span class="${n}"><i class="fa-solid fa-fire"></i> ${e.gas_level}</span></p>
        </div>`,o.onclick=()=>{m()!==e.bus_id&&(f(e.bus_id),u().flyTo({center:[e.longitude,e.latitude],zoom:18,speed:1.5,curve:1}),document.querySelectorAll(".bus-item").forEach(l=>l.classList.remove("active-focus")),o.classList.add("active-focus"))},i.appendChild(o)}function b(e){const i=w.point([e.longitude,e.latitude]);let a=1/0,o="";E.forEach(s=>{const n=w.point([s.lng,s.lat]),c=w.distance(i,n,{units:"kilometers"});c<a&&(a=c,o=s.title)});const t=e.speed&&e.speed>1?e.speed:20;return a<.05?{text:`Tiba di ${o}`,icon:"fa-check-circle",arrived:!0}:{text:`${Math.ceil(a/t*60)} min ke ${o}`,icon:"fa-clock",arrived:!1}}function j(e){e.gas_level>v&&Date.now()-I>3e4&&(Swal.fire({html:`
                <div class="gas-warning-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                <div class="gas-alert-title">GAS TINGGI DETEKSI</div>
                <div class="gas-value-display">${e.gas_level}</div>
                <div class="gas-alert-text">Segera periksa kondisi armada ${e.bus_id}</div>
            `,showConfirmButton:!0,confirmButtonText:"MENGERTI",confirmButtonColor:"#BF1E2E",background:"transparent",customClass:{popup:"gas-alert-popup"},backdrop:"rgba(191,30,46,0.2)"}),I=Date.now())}let T="home";function Z(e){e===T&&e!=="home"&&(e="home"),T=e,document.querySelectorAll(".nav-item").forEach(n=>n.classList.remove("active"));const i=document.querySelector(`.nav-item[onclick*="'${e}'"]`);i&&i.classList.add("active");const a=document.querySelector(".bottom-sheet"),o=document.getElementById("info-page"),t=document.getElementById("faq-page"),s=document.getElementById("route-view");e==="home"?(a.classList.remove("hidden"),o.classList.remove("active-page"),t.classList.remove("active-page"),s.classList.remove("active-page"),s.classList.remove("closing"),m()&&(f(null),document.querySelectorAll(".bus-item").forEach(n=>n.classList.remove("active-focus"))),q(),u()&&u().fitBounds(p,{padding:{top:40,bottom:window.innerWidth<768?230:150,left:20,right:20},speed:1.2,curve:1.42,essential:!0})):e==="map"?(a.classList.add("hidden"),o.classList.remove("active-page"),t.classList.remove("active-page"),s.classList.add("active-page"),u().resize(),u().fitBounds(p,{padding:{top:50,bottom:window.innerWidth<768?230:150,left:20,right:20},speed:.8,curve:1.2})):e==="announcement"?(a.classList.add("hidden"),s.classList.remove("active-page"),t.classList.remove("active-page"),o.classList.add("active-page")):e==="faq"&&(a.classList.add("hidden"),s.classList.remove("active-page"),o.classList.remove("active-page"),t.classList.add("active-page"))}function Q(e){const i=document.getElementById("image-modal"),a=document.getElementById("img01");i.style.display="block",a.src=e}function H(){const e=document.getElementById("image-modal");e.style.display="none"}window.switchTab=Z;window.viewImage=Q;window.closeImage=H;fetch("/api/config").then(e=>e.json()).then(e=>{B(e)}).catch(()=>{});const x=F();x.on("load",()=>{W();try{U()}catch{}G();const e=()=>{const t=document.getElementById("loading-screen");t&&!t.classList.contains("hidden")&&t.classList.add("hidden")};setTimeout(e,300),setTimeout(e,3e3);const i=document.getElementById("skeleton-loader"),a=document.getElementById("empty-state");i&&i.classList.remove("hidden"),a&&(a.style.display="none"),io().on("update_bus",t=>{A(t);const s=document.getElementById("bus-list"),n=document.getElementById(`bus-item-${t.bus_id}`);if(n){const c=S(t);let l=c.class;t.gas_level>v&&(l="dot-red");const g=t.gas_level>v?"text-danger":"",r=b(t);n.innerHTML=`
                <div class="bus-icon-wrapper"><img src="./images/bipol.png"></div>
                <div class="bus-info">
                    <h4>${t.bus_id} <span class="status-dot ${l}"></span> <span class="eta-inline"><i class="fa-solid ${r.icon}"></i> ${r.text}</span></h4>
                    <p><span><i class="fa-solid ${c.icon}"></i> ${c.status}</span> &bull;
                    <span><i class="fa-solid fa-gauge"></i> ${t.speed} km/h</span> &bull;
                    <span class="${g}"><i class="fa-solid fa-fire"></i> ${t.gas_level}</span></p>
                </div>`,n.onclick=()=>{m()!==t.bus_id&&(f(t.bus_id),u()&&u().flyTo({center:[t.longitude,t.latitude],zoom:18,speed:1.5}),document.querySelectorAll(".bus-item").forEach(y=>y.classList.remove("active-focus")),n.classList.add("active-focus"))}}else{const c=document.createElement("div");c.className="bus-item",c.id=`bus-item-${t.bus_id}`;let l=t.speed<1?"dot-gray":"dot-green";c.innerHTML=`
                <div class="bus-icon-wrapper"><img src="./images/bipol.png"></div>
                <div class="bus-info">
                    <h4>${t.bus_id} <span class="status-dot ${l}"></span></h4>
                    <p><span><i class="fa-solid fa-gauge"></i> ${t.speed} km/h</span> &bull;
                    <span><i class="fa-solid fa-fire"></i> ${t.gas_level}</span></p>
                </div>`,c.onclick=()=>{m()!==t.bus_id&&(f(t.bus_id),u()&&u().flyTo({center:[t.longitude,t.latitude],zoom:17.5}),document.querySelectorAll(".bus-item").forEach(g=>g.classList.remove("active-focus")),c.classList.add("active-focus"))},s.appendChild(c)}b(t),j(t),m()===t.bus_id&&u()&&u().flyTo({center:[t.longitude,t.latitude],speed:.5}),document.getElementById("skeleton-loader").classList.add("hidden"),document.getElementById("empty-state").classList.add("hidden"),document.getElementById("empty-state").style.display="none"}),x.on("dragstart",()=>{f(null);const t=document.querySelector(".maplibregl-popup");t&&t.remove()}),x.on("touchmove",()=>{f(null);const t=document.querySelector(".maplibregl-popup");t&&t.remove()})});J();document.addEventListener("keydown",function(e){e.key==="Escape"&&H()});async function X(){try{const a=(await(await fetch("/api/bus/location")).json()).data||[],o=document.getElementById("bus-list"),t=document.getElementById("skeleton-loader"),s=document.getElementById("empty-state");if(t.classList.add("hidden"),t.style.display="none",a.length===0){s.style.display="flex",s.classList.remove("hidden"),Array.from(o.children).forEach(l=>{!l.classList.contains("skeleton-loader")&&!l.classList.contains("empty-state")&&l.remove()});return}else s.style.display="none",s.classList.add("hidden");Array.from(o.children).forEach(l=>{!l.classList.contains("skeleton-loader")&&!l.classList.contains("empty-state")&&l.remove()});const n=new Set;a.forEach((l,g)=>{n.add(l.bus_id),A(l),K(l,o,g),b(l),j(l),m()===l.bus_id&&u()&&u().flyTo({center:[l.longitude,l.latitude],speed:.5})});const c=document.getElementById("collapsed-summary");c&&(c.innerHTML=`<i class="fa-solid fa-bus"></i> ${n.size} Armada Aktif`),V(n)}catch{}}async function Y(){try{const i=await(await fetch("/api/info")).json(),a=document.getElementById("dynamic-info-list");if(!a)return;a.innerHTML="";const o=document.createElement("div");o.className="info-card",o.innerHTML=`
            <div class="info-icon"><i class="fa-solid fa-box-open"></i></div>
            <div class="info-text">
                <div style="font-size:0.75em; color:#64748b; margin-bottom:4px; font-weight:500;">
                    <i class="fa-solid fa-thumbtack" style="transform:rotate(45deg); margin-right:4px;"></i> Tersemat
                </div>
                <h4>Barang Ketinggalan?</h4>
                <p>Lapor segera melalui fitur lost & found kami.</p>
                <button onclick="goToLostItems()" style="margin-top:10px; background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:8px; font-size:0.8rem; cursor:pointer; font-weight:500; display:inline-flex; align-items:center; gap:6px;">
                    Lapor Sekarang <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        `,a.appendChild(o);const t=document.createElement("div");if(t.className="info-card",t.innerHTML=`
            <div class="info-icon"><i class="fa-solid fa-code"></i></div>
            <div class="info-text">
                <div style="font-size:0.75em; color:#64748b; margin-bottom:4px; font-weight:500;">
                    <i class="fa-solid fa-thumbtack" style="transform:rotate(45deg); margin-right:4px;"></i> Tersemat
                </div>
                <h4>Temukan Bug / Saran?</h4>
                <p>Bantu kami kembangkan aplikasi ini jadi lebih baik.</p>
                <button onclick="goToFeedback()" style="margin-top:10px; background:#475569; color:white; border:none; padding:8px 16px; border-radius:8px; font-size:0.8rem; cursor:pointer; font-weight:500; display:inline-flex; align-items:center; gap:6px;">
                    Beri Masukan <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        `,a.appendChild(t),window.goToLostItems=function(){window.switchTab&&window.switchTab("faq"),setTimeout(()=>{const s=document.querySelector(".lost-items-section");s&&s.scrollIntoView({behavior:"smooth",block:"center"})},100)},window.goToFeedback=function(){window.switchTab&&window.switchTab("faq"),setTimeout(()=>{const s=document.querySelector(".feedback-section");s&&s.scrollIntoView({behavior:"smooth",block:"center"})},100)},i.length===0)return;i.forEach(s=>{const n=new Date(s.created_at).toLocaleDateString("id-ID",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}),c=document.createElement("div");c.className="info-card",c.innerHTML=`
                <div class="info-icon"><i class="fa-solid fa-bullhorn"></i></div>
                <div class="info-text">
                    <h4>${s.title}</h4>
                    <p>${s.content}</p>
                    <div style="font-size:0.75em; color:#888; margin-top:5px;"><i class="fa-regular fa-clock"></i> ${n}</div>
                </div>
            `,a.appendChild(c)})}catch{}}X();Y();
