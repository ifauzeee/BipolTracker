<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bipol Admin</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/css/admin.css">
</head>

<body>

    <aside id="sidebar">
        <div class="brand">
            <img src="/images/header.png" alt="Bipol Logo" class="brand-logo">
        </div>
        <nav>
            <button onclick="switchTab('dashboard')" class="nav-item active" id="nav-dashboard">
                <i class="fa-solid fa-border-all"></i> Overview
            </button>
            <button onclick="switchTab('logs')" class="nav-item" id="nav-logs">
                <i class="fa-solid fa-database"></i> Live Logs
            </button>
            <button onclick="switchTab('geofence')" class="nav-item" id="nav-geofence">
                <i class="fa-solid fa-route"></i> Geofence
            </button>
            <button onclick="switchTab('settings')" class="nav-item" id="nav-settings">
                <i class="fa-solid fa-sliders"></i> Settings
            </button>
        </nav>
        <div class="user-panel">
            <div class="user-details">
                <div>
                    <div class="user-name">Admin</div>
                    <div class="user-role">Superuser</div>
                </div>
            </div>
            <button onclick="logout()" class="btn-logout" title="Sign Out">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </button>
        </div>
    </aside>

    <main>
        <header>
            <div>
                <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                <h1 id="page-title">Dashboard</h1>
            </div>
            <div class="date-badge" id="currentDate">
            </div>
        </header>

        <div id="dashboard-section" class="section-container active">
            <div class="grid-dashboard">
                <div class="stat-card">
                    <div class="stat-title">System Status</div>
                    <div class="stat-value">Operational</div>
                    <div class="stat-meta"><i class="fa-solid fa-circle-check"></i> All systems go</div>
                    <i class="fa-solid fa-server stat-icon-bg"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Active Alerts</div>
                    <div class="stat-value" id="infoCount">0</div>
                    <div class="stat-meta">Published</div>
                    <i class="fa-solid fa-bell stat-icon-bg"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Fleet Active</div>
                    <div class="stat-value" id="activeBusCount">0</div>
                    <div class="stat-meta off" id="activeBusMeta">Waiting for data...</div>
                    <i class="fa-solid fa-bus stat-icon-bg"></i>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 40px;">

                <div>
                    <h2 style="font-size:1.1rem; margin-bottom:16px;">Create Announcement</h2>
                    <div class="form-grid">
                        <div class="input-wrapper">
                            <label>Title</label>
                            <input type="text" id="infoTitle" class="styled-input"
                                placeholder="e.g. Schedule Maintenance">
                        </div>
                        <div class="input-wrapper">
                            <label>Message</label>
                            <textarea id="infoContent" class="styled-input" rows="4"
                                placeholder="Enter full details..."></textarea>
                        </div>
                        <button onclick="postInfo()" class="btn-primary">
                            <i class="fa-solid fa-paper-plane"></i> Publish Now
                        </button>
                    </div>
                </div>

                <div>
                    <h2 style="font-size:1.1rem; margin-bottom:16px;">Active Announcements</h2>
                    <div id="infoList" class="list-container">
                        <div style="text-align:center; padding:40px; color:var(--text-light);">Loading...</div>
                    </div>
                </div>

            </div>
        </div>

        <div id="logs-section" class="section-container">
            <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                <div class="input-wrapper" style="flex: 1;">
                    <input type="text" id="filterBusId" class="styled-input" placeholder="Filter by Bus ID..."
                        onkeyup="renderLogs()">
                </div>
                <div class="input-wrapper" style="width: 180px;">
                    <input type="date" id="filterDate" class="styled-input" onchange="renderLogs()">
                </div>
                <div class="input-wrapper" style="width: 200px;">
                    <select id="sortLogs" class="styled-input" onchange="renderLogs()">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="speed_desc">Speed (High-Low)</option>
                        <option value="speed_asc">Speed (Low-High)</option>
                        <option value="gas_desc">Gas (High-Low)</option>
                        <option value="gas_asc">Gas (Low-High)</option>
                    </select>
                </div>
            </div>
            <div class="table-glass">
                <table>
                    <thead>
                        <tr>
                            <th>Bus ID</th>
                            <th>Coordinates</th>
                            <th>Speed</th>
                            <th>Gas</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="geofence-section" class="section-container">
            <div class="table-glass">
                <table>
                    <thead>
                        <tr>
                            <th>Bus ID</th>
                            <th>Zone Name</th>
                            <th>Event Type</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="geofence-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="settings-section" class="section-container">
            <div style="max-width: 500px;">
                <div class="glass-panel">
                    <h2 style="font-size:1.2rem; margin-top:0; margin-bottom:24px;">Security Settings</h2>
                    <div class="form-grid">
                        <div class="input-wrapper">
                            <label>Update Password</label>
                            <input type="password" id="newPassword" class="styled-input"
                                placeholder="New secure password">
                        </div>
                        <button onclick="changePassword()" class="btn-primary">Update Password</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        const socket = io();

        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        fetch('/auth/status').then(r => r.json()).then(data => {
            if (!data.loggedIn) window.location.href = '/login';
            else initDashboard();
        });

        function initDashboard() {
            loadInfo();
            loadLogs();
            loadGeofenceLogs();
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');

            const titles = {
                'dashboard': 'Dashboard',
                'logs': 'Vehicle Logs',
                'geofence': 'Geofence Events',
                'settings': 'Settings'
            };
            document.getElementById('page-title').innerText = titles[tab];

            document.querySelectorAll('.section-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`${tab}-section`).classList.add('active');

            document.getElementById('sidebar').classList.remove('open');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        async function postInfo() {
            const title = document.getElementById('infoTitle').value;
            const content = document.getElementById('infoContent').value;
            if (!title || !content) return Swal.fire({ icon: 'warning', title: 'Missing fields', text: 'Please enter a title and content', toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });

            try {
                const res = await fetch('/api/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content })
                });
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: 'Published', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                    document.getElementById('infoTitle').value = '';
                    document.getElementById('infoContent').value = '';
                    loadInfo();
                }
            } catch (e) { console.error(e); }
        }

        async function loadInfo() {
            const res = await fetch('/api/admin/info');
            const list = await res.json();
            document.getElementById('infoCount').innerText = list.length;
            const container = document.getElementById('infoList');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:30px; border:1px dashed #e5e7eb; border-radius:12px; color:#9ca3af;">No active announcements</div>';
                return;
            }

            list.forEach(item => {
                const card = document.createElement('div');
                card.className = 'list-item-minimal';
                card.innerHTML = `
                    <div class="list-info">
                        <h3>${item.title}</h3>
                        <p>${item.content}</p>
                        <div class="list-meta">Posted on ${new Date(item.created_at).toLocaleDateString()}</div>
                    </div>
                    <button class="btn-icon" onclick="deleteInfo(${item.id})"><i class="fa-solid fa-trash"></i></button>
                `;
                container.appendChild(card);
            });
        }

        async function deleteInfo(id) {
            Swal.fire({
                title: 'Delete?',
                text: "Confirm deletion of this announcement.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#111827',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await fetch('/api/info/' + id, { method: 'DELETE' });
                    loadInfo();
                    Swal.fire({ icon: 'success', title: 'Deleted', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                }
            });
        }

        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (!newPassword) return;
            const res = await fetch('/auth/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newPassword })
            });
            const data = await res.json();
            if (data.success) {
                Swal.fire({ icon: 'success', title: 'Updated', text: 'Password changed successfully' });
                document.getElementById('newPassword').value = '';
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        }

        let allLogs = [];

        async function loadLogs() {
            const res = await fetch('/api/admin/logs');
            allLogs = await res.json();

            allLogs.forEach(log => {
                if (log.bus_id) updateActiveBuses(log.bus_id);
            });

            renderLogs();
        }

        function renderLogs() {
            const tbody = document.getElementById('logs-table-body');
            tbody.innerHTML = '';

            const filterId = document.getElementById('filterBusId').value.toLowerCase();
            const filterDate = document.getElementById('filterDate').value;
            const sortMode = document.getElementById('sortLogs').value;

            let filtered = allLogs.filter(log => {
                const bid = (log.bus_id || '').toLowerCase();
                const matchesId = bid.includes(filterId);

                let matchesDate = true;
                if (filterDate) {
                    const logDate = log.created_at ? new Date(log.created_at).toISOString().split('T')[0] : '';
                    matchesDate = logDate === filterDate;
                }

                return matchesId && matchesDate;
            });

            filtered.sort((a, b) => {
                const dateA = new Date(a.created_at || 0);
                const dateB = new Date(b.created_at || 0);
                const speedA = parseFloat(a.speed || 0);
                const speedB = parseFloat(b.speed || 0);
                const gasA = parseFloat(a.gas_level || 0);
                const gasB = parseFloat(b.gas_level || 0);

                switch (sortMode) {
                    case 'newest': return dateB - dateA;
                    case 'oldest': return dateA - dateB;
                    case 'speed_desc': return speedB - speedA;
                    case 'speed_asc': return speedA - speedB;
                    case 'gas_desc': return gasB - gasA;
                    case 'gas_asc': return gasA - gasB;
                    default: return dateB - dateA;
                }
            });

            filtered.slice(0, 50).forEach(log => {
                const tr = document.createElement('tr');
                const time = log.created_at ? new Date(log.created_at).toLocaleTimeString() : new Date().toLocaleTimeString();

                tr.innerHTML = `
                    <td style="font-weight:700;">${log.bus_id || 'Unknown'}</td>
                    <td class="data-highlight" style="font-size:0.85rem">${(log.latitude || 0).toFixed(5)}, ${(log.longitude || 0).toFixed(5)}</td>
                    <td>${log.speed || 0} km/h</td>
                    <td class="data-highlight">${log.gas_level || 0}</td>
                    <td style="color:var(--text-light);">${time}</td>
                `;
                tbody.appendChild(tr);
            });
        }


        async function loadGeofenceLogs() {
            const tbody = document.getElementById('geofence-table-body');
            tbody.innerHTML = '';
            const res = await fetch('/api/admin/geofence-events');
            const logs = await res.json();
            logs.forEach(log => addGeofenceRow(log, true));
        }

        function addGeofenceRow(log, append = false) {
            const tbody = document.getElementById('geofence-table-body');
            const tr = document.createElement('tr');

            const zone = log.zoneName || log.zone_name || 'Unknown';
            const event = log.event_type;
            const timeVal = log.time || log.timestamp || new Date();
            const time = new Date(timeVal).toLocaleTimeString();

            const pillClass = event === 'ENTER' ? 'status-enter' : 'status-exit';

            tr.innerHTML = `
                <td style="font-weight:700;">${log.bus_id}</td>
                <td>${zone}</td>
                <td><span class="status-pill ${pillClass}">${event}</span></td>
                <td style="color:var(--text-light);">${time}</td>
            `;

            tr.style.animation = "slideUp 0.3s ease-out";

            if (append) tbody.appendChild(tr);
            else tbody.prepend(tr);

            if (tbody.children.length > 50) tbody.removeChild(tbody.lastChild);
        }

        const activeBuses = new Set();

        function updateActiveBuses(busId) {
            if (busId && !activeBuses.has(busId)) {
                activeBuses.add(busId);
                const count = activeBuses.size;
                document.getElementById('activeBusCount').innerText = count;
                const meta = document.getElementById('activeBusMeta');
                meta.innerText = count + ' vehicle(s) online';
                meta.classList.remove('off');
                meta.style.color = '#10B981';
            }
        }

        socket.on('update_bus', (data) => {
            allLogs.unshift(data);
            if (allLogs.length > 200) allLogs.pop();
            updateActiveBuses(data.bus_id);
            renderLogs();
        });
        socket.on('geofence_event', (data) => {
            addGeofenceRow(data);
            updateActiveBuses(data.bus_id);
        });
        socket.on('update_info', () => loadInfo());
    </script>
</body>

</html>