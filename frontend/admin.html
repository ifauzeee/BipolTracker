<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bipol Admin</title>
    <link rel="icon" href="/images/favicon.png" type="image/png">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/src/css/admin.css">
</head>

<body style="visibility: hidden;">

    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

    <aside id="sidebar">
        <div class="brand">
            <img src="/images/header.png" alt="Bipol Logo" class="brand-logo">
        </div>
        <nav>
            <button onclick="switchTab('dashboard')" class="nav-item active" id="nav-dashboard">
                <i class="fa-solid fa-border-all"></i> Overview
            </button>
            <button onclick="switchTab('analytics')" class="nav-item" id="nav-analytics">
                <i class="fa-solid fa-chart-line"></i> Analytics
            </button>
            <button onclick="switchTab('logs')" class="nav-item" id="nav-logs">
                <i class="fa-solid fa-database"></i> Live Logs
            </button>
            <button onclick="switchTab('geofence')" class="nav-item" id="nav-geofence">
                <i class="fa-solid fa-route"></i> Geofence
            </button>
            <button onclick="switchTab('feedback')" class="nav-item" id="nav-feedback">
                <i class="fa-solid fa-comments"></i> Feedback
            </button>
            <button onclick="switchTab('settings')" class="nav-item" id="nav-settings">
                <i class="fa-solid fa-sliders"></i> Settings
            </button>
            <button onclick="switchTab('drivers')" class="nav-item" id="nav-drivers">
                <i class="fa-solid fa-id-card"></i> Drivers
            </button>
        </nav>
        <div class="user-panel">
            <div class="user-details">
                <div>
                    <div class="user-name">Admin</div>
                    <div class="user-role">Superuser</div>
                </div>
            </div>
            <button onclick="logout()" class="btn-logout" title="Sign Out">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </button>
        </div>
    </aside>

    <main>
        <header>
            <div>
                <button class="mobile-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
                <h1 id="page-title">Dashboard</h1>
            </div>
            <div class="date-badge" id="currentDate">
            </div>
        </header>

        <div id="dashboard-section" class="section-container active">
            <div class="grid-dashboard">
                <div class="stat-card">
                    <div class="stat-title">System Status</div>
                    <div class="stat-value">Operational</div>
                    <div class="stat-meta"><i class="fa-solid fa-circle-check"></i> All systems go</div>
                    <i class="fa-solid fa-server stat-icon-bg"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Active Alerts</div>
                    <div class="stat-value" id="infoCount">0</div>
                    <div class="stat-meta">Published</div>
                    <i class="fa-solid fa-bell stat-icon-bg"></i>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Fleet Active</div>
                    <div class="stat-value" id="activeBusCount">0</div>
                    <div class="stat-meta off" id="activeBusMeta">Waiting for data...</div>
                    <i class="fa-solid fa-bus stat-icon-bg"></i>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 40px;">

                <div>
                    <h2 style="font-size:1.1rem; margin-bottom:16px;">Create Announcement</h2>
                    <div class="form-grid">
                        <div class="input-wrapper">
                            <label>Title</label>
                            <input type="text" id="infoTitle" class="styled-input"
                                placeholder="e.g. Schedule Maintenance">
                        </div>
                        <div class="input-wrapper">
                            <label>Message</label>
                            <textarea id="infoContent" class="styled-input" rows="4"
                                placeholder="Enter full details..."></textarea>
                        </div>
                        <button onclick="postInfo()" class="btn-primary">
                            <i class="fa-solid fa-paper-plane"></i> Publish Now
                        </button>
                    </div>
                </div>

                <div>
                    <h2 style="font-size:1.1rem; margin-bottom:16px;">Active Announcements</h2>
                    <div id="infoList" class="list-container">
                        <div style="text-align:center; padding:40px; color:var(--text-light);">Loading...</div>
                    </div>
                </div>

            </div>
        </div>

        <div id="analytics-section" class="section-container">
            <div class="analytics-header">
                <h2 style="font-size:1.2rem; margin:0;">Fleet Analytics</h2>
                <div class="export-buttons">
                    <button onclick="exportToCSV()" class="btn-export">
                        <i class="fa-solid fa-file-csv"></i> Export CSV
                    </button>
                    <button onclick="exportToPDF()" class="btn-export">
                        <i class="fa-solid fa-file-pdf"></i> Export PDF
                    </button>
                </div>
            </div>

            <div class="analytics-stats">
                <div class="analytics-stat-card">
                    <i class="fa-solid fa-gauge-high stat-icon"></i>
                    <div class="stat-info">
                        <div class="stat-label">Avg Speed</div>
                        <div class="stat-number" id="avgSpeed">0 km/h</div>
                    </div>
                </div>
                <div class="analytics-stat-card">
                    <i class="fa-solid fa-fire stat-icon" style="color:#ef4444;"></i>
                    <div class="stat-info">
                        <div class="stat-label">Max Gas Level</div>
                        <div class="stat-number" id="maxGas">0</div>
                    </div>
                </div>
                <div class="analytics-stat-card">
                    <i class="fa-solid fa-clock stat-icon" style="color:#10b981;"></i>
                    <div class="stat-info">
                        <div class="stat-label">Active Hours</div>
                        <div class="stat-number" id="activeHours">0h</div>
                    </div>
                </div>
                <div class="analytics-stat-card">
                    <i class="fa-solid fa-route stat-icon" style="color:#8b5cf6;"></i>
                    <div class="stat-info">
                        <div class="stat-label">Total Entries</div>
                        <div class="stat-number" id="totalEntries">0</div>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3><i class="fa-solid fa-chart-area"></i> Speed Over Time</h3>
                    <canvas id="speedChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3><i class="fa-solid fa-chart-bar"></i> Gas Level Distribution</h3>
                    <canvas id="gasChart"></canvas>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3><i class="fa-solid fa-chart-pie"></i> Bus Activity</h3>
                    <canvas id="activityChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3><i class="fa-solid fa-list"></i> Top Geofence Events</h3>
                    <div id="topGeofenceEvents" class="top-events-list">
                        <div style="text-align:center; padding:20px; color:var(--text-light);">Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="logs-section" class="section-container">
            <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                <div class="input-wrapper" style="flex: 1;">
                    <input type="text" id="filterBusId" class="styled-input" placeholder="Filter by Bus ID..."
                        onkeyup="renderLogs()">
                </div>
                <div class="input-wrapper" style="width: 180px;">
                    <input type="date" id="filterDate" class="styled-input" onchange="renderLogs()">
                </div>
                <div class="input-wrapper" style="width: 200px;">
                    <select id="sortLogs" class="styled-input" onchange="renderLogs()">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="speed_desc">Speed (High-Low)</option>
                        <option value="speed_asc">Speed (Low-High)</option>
                        <option value="gas_desc">Gas (High-Low)</option>
                        <option value="gas_asc">Gas (Low-High)</option>
                    </select>
                </div>
            </div>
            <div class="table-glass">
                <table>
                    <thead>
                        <tr>
                            <th>Bus ID</th>
                            <th>Coordinates</th>
                            <th>Speed</th>
                            <th>Gas</th>
                            <th>Time</th>
                        </tr>
                    </thead>
                    <tbody id="logs-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="geofence-section" class="section-container">
            <div class="table-glass">
                <table>
                    <thead>
                        <tr>
                            <th>Bus ID</th>
                            <th>Zone Name</th>
                            <th>Event Type</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody id="geofence-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="settings-section" class="section-container">
            <div class="settings-grid">
                <div class="settings-card">
                    <h2><i class="fa-solid fa-lock"></i> Security Settings</h2>
                    <div class="form-grid">
                        <div class="input-wrapper">
                            <label>Update Password</label>
                            <input type="password" id="newPassword" class="styled-input"
                                placeholder="New secure password">
                        </div>
                        <button onclick="changePassword()" class="btn-primary">Update Password</button>
                    </div>
                </div>

                <div class="settings-card">
                    <h2><i class="fa-solid fa-server"></i> System Health</h2>
                    <div id="systemHealth" class="system-health">
                        <div class="health-item">
                            <span>Status</span>
                            <span class="health-value" id="healthStatus">--</span>
                        </div>
                        <div class="health-item">
                            <span>Uptime</span>
                            <span class="health-value" id="healthUptime">--</span>
                        </div>
                        <div class="health-item">
                            <span>Memory Usage</span>
                            <span class="health-value" id="healthMemory">--</span>
                        </div>
                        <div class="health-item">
                            <span>Active Connections</span>
                            <span class="health-value" id="healthConnections">--</span>
                        </div>
                    </div>
                    <div style="margin-top:20px;">
                        <button onclick="loadSystemHealth()" class="btn-secondary">
                            <i class="fa-solid fa-rotate-right"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="settings-card">
                    <h2><i class="fa-solid fa-bell"></i> Alert Configuration</h2>
                    <div class="form-grid">
                        <div class="input-wrapper">
                            <label>Gas Alert Threshold</label>
                            <input type="number" id="gasThreshold" class="styled-input" placeholder="Default: 600"
                                min="0" max="10000">
                            <small style="color:var(--text-light);">Alert ketika gas level melebihi nilai ini</small>
                        </div>
                        <div class="input-wrapper">
                            <label>Bus Stop Timeout (minutes)</label>
                            <input type="number" id="stopTimeout" class="styled-input" placeholder="Default: 5" min="1"
                                max="60">
                            <small style="color:var(--text-light);">Waktu sebelum bus dianggap parkir</small>
                        </div>
                        <button onclick="saveAlertConfig()" class="btn-primary">Save Configuration</button>
                    </div>


                </div>
            </div>
        </div>


        <div id="drivers-section" class="section-container">
            <div style="display: flex; gap: 40px; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 300px;">
                    <div class="settings-card">
                        <h2><i class="fa-solid fa-user-plus"></i> Add New Driver</h2>
                        <div class="form-grid">
                            <div class="input-wrapper">
                                <label>Nomer Plat Bus (ID)</label>
                                <input type="text" id="newBusPlate" class="styled-input" placeholder="e.g. B 1234 XYZ">
                                <small style="color:var(--text-light);">Use this as Login ID</small>
                            </div>
                            <div class="input-wrapper">
                                <label>Driver Name (Optional)</label>
                                <input type="text" id="newDriverName" class="styled-input"
                                    placeholder="e.g. Budi Santoso">
                            </div>
                            <div class="input-wrapper">
                                <label>Password (Optional)</label>
                                <input type="text" id="newDriverPassword" class="styled-input"
                                    placeholder="Auto-generated if empty">
                            </div>
                            <button onclick="addDriver()" class="btn-primary">
                                <i class="fa-solid fa-plus"></i> Create Account
                            </button>
                        </div>
                    </div>
                </div>

                <div style="flex: 2; min-width: 300px;">
                    <div class="settings-card">
                        <h2><i class="fa-solid fa-users"></i> Registered Drivers</h2>
                        <div class="table-glass">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Bus Plate</th>
                                        <th>Driver Name</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="drivers-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="feedback-section" class="section-container">
            <div class="sub-nav">
                <button class="sub-nav-item active" onclick="switchSubTab('lostitems')" id="subnav-lostitems">Lost
                    Items</button>
                <button class="sub-nav-item" onclick="switchSubTab('general')" id="subnav-general">General
                    Feedback</button>
            </div>

            <div id="sub-lostitems" class="sub-section active">
                <div class="table-glass">
                    <table>
                        <thead>
                            <tr>
                                <th>Waktu</th>
                                <th>Plat Bus</th>
                                <th>WhatsApp</th>
                                <th>Pesan</th>
                                <th>Status</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="lostitems-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="sub-general" class="sub-section">
                <div class="table-glass">
                    <table>
                        <thead>
                            <tr>
                                <th>Waktu</th>
                                <th>Nama</th>
                                <th>Pesan</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="feedback-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        const socket = io();

        document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        fetch('/auth/status').then(r => r.json()).then(data => {
            if (!data.loggedIn) {
                window.location.href = '/login';
            } else {
                document.body.style.visibility = 'visible';
                initDashboard();
            }
        });

        function initDashboard() {
            loadInfo();
            loadLogs();
            loadGeofenceLogs();
            loadLostItems();
            loadFeedback();
            loadSystemHealth();
            loadAlertConfig();
        }

        function switchTab(tab) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${tab}`).classList.add('active');

            const titles = {
                'dashboard': 'Dashboard',
                'analytics': 'Analytics',
                'logs': 'Vehicle Logs',
                'geofence': 'Geofence Events',
                'geofence': 'Geofence Events',
                'feedback': 'User Feedback',
                'settings': 'Settings',
                'drivers': 'Manage Drivers'
            };
            document.getElementById('page-title').innerText = titles[tab];

            document.querySelectorAll('.section-container').forEach(el => el.classList.remove('active'));
            document.getElementById(`${tab}-section`).classList.add('active');

            if (tab === 'analytics') {
                initCharts();
            } else if (tab === 'drivers') {
                loadDrivers();
            }

            closeSidebar();
        }

        async function loadDrivers() {
            const tbody = document.getElementById('drivers-table-body');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Loading...</td></tr>';
            try {
                const res = await fetch('/api/admin/drivers');
                const data = await res.json();

                tbody.innerHTML = '';
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No drivers found</td></tr>';
                    return;
                }

                data.forEach(d => {
                    const tr = document.createElement('tr');
                    const safePlate = d.bus_plate.replace(/'/g, "\\'");
                    const safeName = (d.driver_name || '').replace(/'/g, "\\'");

                    tr.innerHTML = `
                        <td style="font-weight:600;">${d.bus_plate}</td>
                        <td>${d.driver_name || '-'}</td>
                        <td>
                             <button class="btn-icon" onclick="openEditDriver('${d.id}', '${safePlate}', '${safeName}')" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
                             <button class="btn-icon" onclick="resetDriverPassword('${d.id}')" title="Reset PW"><i class="fa-solid fa-key"></i></button>
                             <button class="btn-icon" onclick="deleteDriver('${d.id}')" title="Delete" style="color:#ef4444;"><i class="fa-solid fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:red;">Failed to load</td></tr>';
            }
        }

        async function addDriver() {
            const plate = document.getElementById('newBusPlate').value;
            const name = document.getElementById('newDriverName').value;
            const password = document.getElementById('newDriverPassword').value;

            if (!plate) return Swal.fire('Error', 'Bus plate is required', 'error');

            try {
                const res = await fetch('/api/admin/drivers', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ bus_plate: plate, driver_name: name, password: password })
                });
                const data = await res.json();

                if (data.success) {
                    Swal.fire({
                        title: 'Success!',
                        html: `Driver created.<br><b>ID: ${data.data.bus_plate}</b><br><b>Password: ${data.generatedPassword}</b>`,
                        icon: 'success'
                    });
                    document.getElementById('newBusPlate').value = '';
                    document.getElementById('newDriverName').value = '';
                    document.getElementById('newDriverPassword').value = '';
                    loadDrivers();
                } else {
                    Swal.fire('Error', data.error || 'Failed', 'error');
                }
            } catch (e) {
                Swal.fire('Error', 'Network error', 'error');
            }
        }

        async function deleteDriver(id) {
            Swal.fire({
                title: 'Delete Driver?',
                text: "Confirm deletion.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                confirmButtonText: 'Delete'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await fetch('/api/admin/drivers/' + id, { method: 'DELETE' });
                    loadDrivers();
                    Swal.fire('Deleted', '', 'success');
                }
            });
        }

        async function openEditDriver(id, currentPlate, currentName) {
            Swal.fire({
                title: 'Edit Driver',
                html: `
                    <div style="text-align:left;">
                        <label style="display:block;margin-bottom:5px;font-weight:500;">Bus Plate</label>
                        <input id="editBusPlate" class="swal2-input" style="margin:0 0 15px 0;width:100%;box-sizing:border-box;" value="${currentPlate}">
                        
                        <label style="display:block;margin-bottom:5px;font-weight:500;">Driver Name</label>
                        <input id="editDriverName" class="swal2-input" style="margin:0 0 15px 0;width:100%;box-sizing:border-box;" value="${currentName}">
                        
                        <label style="display:block;margin-bottom:5px;font-weight:500;">New Password (Optional)</label>
                        <input id="editDriverPass" type="password" class="swal2-input" style="margin:0;width:100%;box-sizing:border-box;" placeholder="Leave empty to keep current">
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                preConfirm: () => {
                    return {
                        bus_plate: document.getElementById('editBusPlate').value,
                        driver_name: document.getElementById('editDriverName').value,
                        password: document.getElementById('editDriverPass').value
                    }
                }
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const updates = result.value;
                    try {
                        const res = await fetch(`/api/admin/drivers/${id}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(updates)
                        });
                        const data = await res.json();

                        if (res.ok) {
                            Swal.fire('Success', 'Driver updated successfully', 'success');
                            loadDrivers();
                        } else {
                            Swal.fire('Error', data.error || 'Failed to update', 'error');
                        }
                    } catch (e) {
                        Swal.fire('Error', 'Network error', 'error');
                    }
                }
            });
        }

        async function resetDriverPassword(id) {
            Swal.fire({
                title: 'Reset Password?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, reset'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    const res = await fetch(`/api/admin/drivers/${id}/reset-password`, { method: 'PATCH' });
                    const data = await res.json();
                    if (data.success) {
                        Swal.fire({
                            title: 'Password Reset',
                            html: `New Password: <b>${data.newPassword}</b>`,
                            icon: 'success'
                        });
                    }
                }
            });
        }


        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        async function logout() {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        async function postInfo() {
            const title = document.getElementById('infoTitle').value;
            const content = document.getElementById('infoContent').value;
            if (!title || !content) return Swal.fire({ icon: 'warning', title: 'Missing fields', text: 'Please enter a title and content', toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });

            try {
                const res = await fetch('/api/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, content })
                });
                if (res.ok) {
                    Swal.fire({ icon: 'success', title: 'Published', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                    document.getElementById('infoTitle').value = '';
                    document.getElementById('infoContent').value = '';
                    loadInfo();
                }
            } catch (e) { console.error(e); }
        }

        async function loadInfo() {
            const res = await fetch('/api/admin/info');
            const list = await res.json();
            document.getElementById('infoCount').innerText = list.length;
            const container = document.getElementById('infoList');
            container.innerHTML = '';

            if (list.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa-solid fa-bullhorn"></i>
                        <div class="empty-state-text">Belum ada pengumuman</div>
                        <div class="empty-state-sub">Buat pengumuman baru di form di atas</div>
                    </div>
                `;
                return;
            }

            list.forEach(item => {
                const card = document.createElement('div');
                card.className = 'list-item-minimal';
                card.innerHTML = `
                    <div class="list-info">
                        <h3>${item.title}</h3>
                        <p>${item.content}</p>
                        <div class="list-meta">Posted on ${new Date(item.created_at).toLocaleDateString()}</div>
                    </div>
                    <button class="btn-icon" onclick="deleteInfo('${item.id}')"><i class="fa-solid fa-trash"></i></button>
                `;
                container.appendChild(card);
            });
        }

        async function deleteInfo(id) {
            Swal.fire({
                title: 'Delete?',
                text: "Confirm deletion of this announcement.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#111827',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await fetch('/api/info/' + id, { method: 'DELETE' });
                    loadInfo();
                    Swal.fire({ icon: 'success', title: 'Deleted', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                }
            });
        }

        async function changePassword() {
            const newPassword = document.getElementById('newPassword').value;
            if (!newPassword) return;
            const res = await fetch('/auth/change-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ newPassword })
            });
            const data = await res.json();
            if (data.success) {
                Swal.fire({ icon: 'success', title: 'Updated', text: 'Password changed successfully' });
                document.getElementById('newPassword').value = '';
            } else {
                Swal.fire('Error', data.message, 'error');
            }
        }

        let allLogs = [];

        async function loadLogs() {
            const res = await fetch('/api/admin/logs');
            allLogs = await res.json();

            allLogs.forEach(log => {
                if (log.bus_id) updateActiveBuses(log.bus_id);
            });

            renderLogs();
        }

        function renderLogs() {
            const tbody = document.getElementById('logs-table-body');
            tbody.innerHTML = '';

            const filterId = document.getElementById('filterBusId').value.toLowerCase();
            const filterDate = document.getElementById('filterDate').value;
            const sortMode = document.getElementById('sortLogs').value;

            let filtered = allLogs.filter(log => {
                const bid = (log.bus_id || '').toLowerCase();
                const matchesId = bid.includes(filterId);

                let matchesDate = true;
                if (filterDate) {
                    const logDate = log.created_at ? new Date(log.created_at).toISOString().split('T')[0] : '';
                    matchesDate = logDate === filterDate;
                }

                return matchesId && matchesDate;
            });

            filtered.sort((a, b) => {
                const dateA = new Date(a.created_at || 0);
                const dateB = new Date(b.created_at || 0);
                const speedA = parseFloat(a.speed || 0);
                const speedB = parseFloat(b.speed || 0);
                const gasA = parseFloat(a.gas_level || 0);
                const gasB = parseFloat(b.gas_level || 0);

                switch (sortMode) {
                    case 'newest': return dateB - dateA;
                    case 'oldest': return dateA - dateB;
                    case 'speed_desc': return speedB - speedA;
                    case 'speed_asc': return speedA - speedB;
                    case 'gas_desc': return gasB - gasA;
                    case 'gas_asc': return gasA - gasB;
                    default: return dateB - dateA;
                }
            });

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="5">
                            <div class="empty-state">
                                <i class="fa-solid fa-database"></i>
                                <div class="empty-state-text">Belum ada data log</div>
                                <div class="empty-state-sub">Data akan muncul saat bus mulai beroperasi</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            filtered.slice(0, 50).forEach(log => {
                const tr = document.createElement('tr');
                const time = log.created_at ? new Date(log.created_at).toLocaleTimeString() : new Date().toLocaleTimeString();

                tr.innerHTML = `
                    <td style="font-weight:700;">${log.bus_id || 'Unknown'}</td>
                    <td class="data-highlight" style="font-size:0.85rem">${(log.latitude || 0).toFixed(5)}, ${(log.longitude || 0).toFixed(5)}</td>
                    <td>${log.speed || 0} km/h</td>
                    <td class="data-highlight">${log.gas_level || 0}</td>
                    <td style="color:var(--text-light);">${time}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function loadGeofenceLogs() {
            const tbody = document.getElementById('geofence-table-body');
            tbody.innerHTML = '';
            const res = await fetch('/api/admin/geofence-events');
            const logs = await res.json();
            if (logs.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="4">
                            <div class="empty-state">
                                <i class="fa-solid fa-route"></i>
                                <div class="empty-state-text">Belum ada event geofence</div>
                                <div class="empty-state-sub">Event akan muncul saat bus memasuki/keluar zona</div>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            logs.forEach(log => addGeofenceRow(log, true));
        }

        function addGeofenceRow(log, append = false) {
            const tbody = document.getElementById('geofence-table-body');
            const tr = document.createElement('tr');

            const zone = log.zoneName || log.zone_name || 'Unknown';
            const event = log.event_type;
            const timeVal = log.time || log.timestamp || new Date();
            const time = new Date(timeVal).toLocaleTimeString();

            const pillClass = event === 'ENTER' ? 'status-enter' : 'status-exit';

            tr.innerHTML = `
                <td style="font-weight:700;">${log.bus_id}</td>
                <td>${zone}</td>
                <td><span class="status-pill ${pillClass}">${event}</span></td>
                <td style="color:var(--text-light);">${time}</td>
            `;

            tr.style.animation = "slideUp 0.3s ease-out";

            if (append) tbody.appendChild(tr);
            else tbody.prepend(tr);

            if (tbody.children.length > 50) tbody.removeChild(tbody.lastChild);
        }

        const activeBuses = new Set();

        function updateActiveBuses(busId) {
            if (busId && !activeBuses.has(busId)) {
                activeBuses.add(busId);
                const count = activeBuses.size;
                document.getElementById('activeBusCount').innerText = count;
                const meta = document.getElementById('activeBusMeta');
                meta.innerText = count + ' vehicle(s) online';
                meta.classList.remove('off');
                meta.style.color = '#10B981';
            }
        }

        socket.on('update_bus', (data) => {
            allLogs.unshift(data);
            if (allLogs.length > 200) allLogs.pop();
            updateActiveBuses(data.bus_id);
            renderLogs();
        });
        socket.on('geofence_event', (data) => {
            addGeofenceRow(data);
            updateActiveBuses(data.bus_id);
        });
        socket.on('update_info', () => loadInfo());
        socket.on('new_lost_item', (data) => {
            addLostItemRow(data, false);
            Swal.fire({
                icon: 'info',
                title: 'Laporan Baru!',
                text: `Barang ketinggalan di bus ${data.bus_plate}`,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000
            });
        });
        socket.on('update_lost_items', () => loadLostItems());
        socket.on('new_feedback', (data) => {
            addFeedbackRow(data, false);
            Swal.fire({
                icon: 'info',
                title: 'Masukan Baru!',
                text: `${data.name} mengirim masukan`,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 5000
            });
        });
        socket.on('update_feedback', () => loadFeedback());

        function switchSubTab(tab) {
            document.querySelectorAll('.sub-nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`subnav-${tab}`).classList.add('active');

            document.querySelectorAll('.sub-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`sub-${tab}`).classList.add('active');
        }

        async function loadFeedback() {
            const tbody = document.getElementById('feedback-table-body');
            tbody.innerHTML = '';
            try {
                const res = await fetch('/api/admin/feedback');
                const data = await res.json();
                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr class="empty-row">
                            <td colspan="4">
                                <div class="empty-state">
                                    <i class="fa-solid fa-comments"></i>
                                    <div class="empty-state-text">Belum ada masukan</div>
                                    <div class="empty-state-sub">Masukan dari pengguna akan muncul di sini</div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                data.forEach(item => addFeedbackRow(item, true));
            } catch (e) {
                console.error('Failed to load feedback:', e);
            }
        }

        function addFeedbackRow(item, append = true) {
            const tbody = document.getElementById('feedback-table-body');
            const tr = document.createElement('tr');
            tr.id = `feedback-${item.id}`;

            const time = new Date(item.created_at).toLocaleString('id-ID', {
                day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
            });

            tr.innerHTML = `
                <td style="font-size:0.85rem;">${time}</td>
                <td style="font-weight:700;">${item.name || 'Anonim'}</td>
                <td>${item.message}</td>
                <td>
                    <button class="btn-icon" onclick="deleteFeedback('${item.id}')" title="Hapus"><i class="fa-solid fa-trash"></i></button>
                </td>
            `;

            if (append) tbody.appendChild(tr);
            else tbody.prepend(tr);
        }

        async function deleteFeedback(id) {
            Swal.fire({
                title: 'Hapus Masukan?',
                text: "Tidak dapat dikembalikan.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#111827',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, hapus'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await fetch('/api/admin/feedback/' + id, { method: 'DELETE' });
                    loadFeedback();
                    Swal.fire({ icon: 'success', title: 'Terhapus', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
                }
            });
        }

        async function loadLostItems() {
            const tbody = document.getElementById('lostitems-table-body');
            tbody.innerHTML = '';
            try {
                const res = await fetch('/api/admin/lost-items');
                const data = await res.json();
                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr class="empty-row">
                            <td colspan="6">
                                <div class="empty-state">
                                    <i class="fa-solid fa-box-open"></i>
                                    <div class="empty-state-text">Belum ada laporan barang hilang</div>
                                    <div class="empty-state-sub">Laporan akan muncul saat penumpang melaporkan</div>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                data.forEach(item => addLostItemRow(item, true));
            } catch (e) {
                console.error('Failed to load lost items:', e);
            }
        }

        function addLostItemRow(item, append = true) {
            const tbody = document.getElementById('lostitems-table-body');
            const tr = document.createElement('tr');
            tr.id = `lost-item-${item.id}`;

            const time = new Date(item.created_at).toLocaleString('id-ID', {
                day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'
            });

            const statusColors = {
                'pending': 'status-pending',
                'resolved': 'status-resolved',
                'rejected': 'status-rejected'
            };
            const statusLabels = {
                'pending': 'Menunggu',
                'resolved': 'Selesai',
                'rejected': 'Ditolak'
            };

            tr.innerHTML = `
                <td style="font-size:0.85rem;">${time}</td>
                <td style="font-weight:700;">${item.bus_plate}</td>
                <td><a href="https://wa.me/${item.whatsapp_number.replace(/^0/, '62')}" target="_blank" style="color:#25D366;">${item.whatsapp_number}</a></td>
                <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${item.message}">${item.message}</td>
                <td><span class="status-pill ${statusColors[item.status] || 'status-pending'}">${statusLabels[item.status] || item.status}</span></td>
                <td>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <select onchange="updateLostItemStatus('${item.id}', this.value)" class="status-select" ${item.status !== 'pending' ? 'disabled' : ''}>
                            <option value="pending" ${item.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="resolved" ${item.status === 'resolved' ? 'selected' : ''}>Selesai</option>
                            <option value="rejected" ${item.status === 'rejected' ? 'selected' : ''}>Tolak</option>
                        </select>
                        <button class="btn-icon" onclick="deleteLostItem('${item.id}')" title="Hapus"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </td>
            `;

            if (append) tbody.appendChild(tr);
            else tbody.prepend(tr);
        }

        async function updateLostItemStatus(id, status) {
            try {
                const res = await fetch(`/api/admin/lost-items/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                if (res.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Status Updated',
                        toast: true,
                        position: 'top-end',
                        showConfirmButton: false,
                        timer: 2000
                    });
                    loadLostItems();
                }
            } catch (e) {
                console.error('Failed to update status:', e);
            }
        }

        async function deleteLostItem(id) {
            Swal.fire({
                title: 'Hapus Laporan?',
                text: "Data yang dihapus tidak dapat dikembalikan.",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#111827',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Ya, hapus',
                cancelButtonText: 'Batal'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        const res = await fetch(`/api/admin/lost-items/${id}`, {
                            method: 'DELETE'
                        });
                        if (res.ok) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Terhapus!',
                                text: 'Laporan berhasil dihapus.',
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 2000
                            });
                            loadLostItems();
                        } else {
                            Swal.fire('Error', 'Gagal menghapus laporan.', 'error');
                        }
                    } catch (e) {
                        console.error('Failed to delete:', e);
                        Swal.fire('Error', 'Gagal menghapus laporan.', 'error');
                    }
                }
            });
        }

        let speedChart, gasChart, activityChart;
        let chartsInitialized = false;

        function initCharts() {
            if (chartsInitialized || !allLogs.length) return;
            chartsInitialized = true;

            const avgSpeed = allLogs.reduce((sum, log) => sum + (log.speed || 0), 0) / allLogs.length;
            const maxGas = Math.max(...allLogs.map(log => log.gas_level || 0));
            const uniqueHours = new Set(allLogs.map(log => new Date(log.created_at).getHours())).size;

            document.getElementById('avgSpeed').textContent = avgSpeed.toFixed(1) + ' km/h';
            document.getElementById('maxGas').textContent = maxGas;
            document.getElementById('activeHours').textContent = uniqueHours + 'h';
            document.getElementById('totalEntries').textContent = allLogs.length;

            const last20 = allLogs.slice(0, 20).reverse();
            const speedLabels = last20.map(log => new Date(log.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
            const speedData = last20.map(log => log.speed || 0);

            const ctx1 = document.getElementById('speedChart').getContext('2d');
            speedChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: speedLabels,
                    datasets: [{
                        label: 'Speed (km/h)',
                        data: speedData,
                        borderColor: '#BF1E2E',
                        backgroundColor: 'rgba(191, 30, 46, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            const gasRanges = { '0-200': 0, '200-400': 0, '400-600': 0, '600+': 0 };
            allLogs.forEach(log => {
                const g = log.gas_level || 0;
                if (g < 200) gasRanges['0-200']++;
                else if (g < 400) gasRanges['200-400']++;
                else if (g < 600) gasRanges['400-600']++;
                else gasRanges['600+']++;
            });

            const ctx2 = document.getElementById('gasChart').getContext('2d');
            gasChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: Object.keys(gasRanges),
                    datasets: [{
                        label: 'Count',
                        data: Object.values(gasRanges),
                        backgroundColor: ['#10b981', '#f59e0b', '#f97316', '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });

            const busActivity = {};
            allLogs.forEach(log => {
                busActivity[log.bus_id] = (busActivity[log.bus_id] || 0) + 1;
            });

            const ctx3 = document.getElementById('activityChart').getContext('2d');
            activityChart = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(busActivity),
                    datasets: [{
                        data: Object.values(busActivity),
                        backgroundColor: ['#BF1E2E', '#159BB3', '#10b981', '#8b5cf6', '#f59e0b']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });

            loadTopGeofenceEvents();
        }

        async function loadTopGeofenceEvents() {
            try {
                const res = await fetch('/api/admin/geofence-events');
                const events = await res.json();
                const container = document.getElementById('topGeofenceEvents');

                if (!events.length) {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-light);">No events</div>';
                    return;
                }

                container.innerHTML = events.slice(0, 5).map(e => `
                    <div class="event-item">
                        <span class="event-bus">${e.bus_id}</span>
                        <span class="event-zone">${e.zone_name}</span>
                        <span class="event-type ${e.event_type === 'ENTER' ? 'enter' : 'exit'}">${e.event_type}</span>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load geofence events:', e);
            }
        }

        function exportToCSV() {
            if (!allLogs.length) {
                Swal.fire({ icon: 'warning', title: 'No Data', text: 'No data to export' });
                return;
            }

            const headers = ['Bus ID', 'Latitude', 'Longitude', 'Speed', 'Gas Level', 'Time'];
            const rows = allLogs.map(log => [
                log.bus_id,
                log.latitude,
                log.longitude,
                log.speed,
                log.gas_level,
                new Date(log.created_at).toLocaleString()
            ]);

            const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `bipol_logs_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();

            Swal.fire({ icon: 'success', title: 'Exported!', text: 'CSV file downloaded', toast: true, position: 'top-end', showConfirmButton: false, timer: 2000 });
        }

        function exportToPDF() {
            if (!allLogs.length) {
                Swal.fire({ icon: 'warning', title: 'No Data', text: 'No data to export' });
                return;
            }

            var printWindow = window.open('', '_blank');
            var avgSpeed = (allLogs.reduce(function (sum, log) { return sum + (log.speed || 0); }, 0) / allLogs.length).toFixed(1);
            var maxGas = Math.max.apply(null, allLogs.map(function (log) { return log.gas_level || 0; }));

            var html = '<!DOCTYPE html><html><head>';
            html += '<title>Bipol Report - ' + new Date().toLocaleDateString() + '</title>';
            html += '<style>body{font-family:Arial,sans-serif;padding:20px}h1{color:#BF1E2E}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #ddd;padding:8px;text-align:left}th{background:#f4f4f4}.summary{display:flex;gap:20px;margin:20px 0}.summary-item{background:#f8f8f8;padding:15px;border-radius:8px}</style>';
            html += '</head><body>';
            html += '<h1>Bipol Fleet Report</h1>';
            html += '<p>Generated: ' + new Date().toLocaleString() + '</p>';
            html += '<div class="summary">';
            html += '<div class="summary-item"><strong>Total Entries:</strong> ' + allLogs.length + '</div>';
            html += '<div class="summary-item"><strong>Avg Speed:</strong> ' + avgSpeed + ' km/h</div>';
            html += '<div class="summary-item"><strong>Max Gas:</strong> ' + maxGas + '</div>';
            html += '</div>';
            html += '<table><thead><tr><th>Bus ID</th><th>Coordinates</th><th>Speed</th><th>Gas</th><th>Time</th></tr></thead><tbody>';

            allLogs.slice(0, 50).forEach(function (log) {
                html += '<tr>';
                html += '<td>' + log.bus_id + '</td>';
                html += '<td>' + (log.latitude ? log.latitude.toFixed(5) : 0) + ', ' + (log.longitude ? log.longitude.toFixed(5) : 0) + '</td>';
                html += '<td>' + log.speed + ' km/h</td>';
                html += '<td>' + log.gas_level + '</td>';
                html += '<td>' + new Date(log.created_at).toLocaleString() + '</td>';
                html += '</tr>';
            });

            html += '</tbody></table>';
            html += '<scr' + 'ipt>window.print();</scr' + 'ipt>';
            html += '</body></html>';

            printWindow.document.write(html);
            printWindow.document.close();
        }

        async function loadSystemHealth() {
            try {
                var res = await fetch('/api/health');
                var data = await res.json();
                document.getElementById('healthStatus').innerHTML = '<span style="color:#10b981;"> ' + data.status + '</span>';
                var hours = Math.floor(data.uptime / 3600);
                var minutes = Math.floor((data.uptime % 3600) / 60);
                document.getElementById('healthUptime').textContent = hours + 'h ' + minutes + 'm';
                var memMB = (data.memory.heapUsed / 1024 / 1024).toFixed(1);
                document.getElementById('healthMemory').textContent = memMB + ' MB';
                document.getElementById('healthConnections').textContent = data.connections || 0;
            } catch (e) {
                document.getElementById('healthStatus').innerHTML = '<span style="color:#ef4444;"> Error</span>';
            }
        }

        function loadAlertConfig() {
            fetch('/api/config').then(function (r) { return r.json(); }).then(function (config) {
                document.getElementById('gasThreshold').placeholder = 'Current: ' + config.gasAlertThreshold;
                document.getElementById('stopTimeout').placeholder = 'Current: ' + config.busStopTimeoutMinutes;
            });
        }

        function saveAlertConfig() {
            var gasThreshold = document.getElementById('gasThreshold').value;
            var stopTimeout = document.getElementById('stopTimeout').value;
            var msg = '<p>To change these values, update your .env file:</p>';
            msg += '<pre style="text-align:left;background:#f5f5f5;padding:10px;border-radius:8px;">';
            msg += 'GAS_ALERT_THRESHOLD=' + (gasThreshold || 600) + '\n';
            msg += 'BUS_STOP_TIMEOUT_MINUTES=' + (stopTimeout || 5);
            msg += '</pre><p>Then restart the server.</p>';
            Swal.fire({
                icon: 'info',
                title: 'Server Configuration',
                html: msg,
                confirmButtonColor: '#111827'
            });
        }
    </script>
</body>

</html>