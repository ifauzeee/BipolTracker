import*as B from"https://cdn.jsdelivr.net/npm/@turf/turf@7/+esm";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const t of s)if(t.type==="childList")for(const c of t.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function o(s){const t={};return s.integrity&&(t.integrity=s.integrity),s.referrerPolicy&&(t.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?t.credentials="include":s.crossOrigin==="anonymous"?t.credentials="omit":t.credentials="same-origin",t}function a(s){if(s.ep)return;s.ep=!0;const t=o(s);fetch(s.href,t)}})();const I=[{lng:106.823983,lat:-6.371168,title:"Halte PNJ"},{lng:106.831581,lat:-6.360951,title:"Halte St. UI"},{lng:106.831678,lat:-6.368193,title:"Halte Pondok Cina"},{lng:106.831739,lat:-6.353486,title:"Halte Menwa"}],A=[[106.82442672767823,-6.371652849002165],[106.82406284331717,-6.371666869491176],[106.82400869439084,-6.371629588149347],[106.82397919037493,-6.3713856816309535],[106.82396309736485,-6.371125781310585],[106.82394968631164,-6.370600649527726],[106.82392822882588,-6.370250116860132],[106.82419510857854,-6.370231457453673],[106.82403417601651,-6.366948701129196],[106.82307662740313,-6.366927375783644],[106.82295190468999,-6.366928708593834],[106.82265038025012,-6.366877515581393],[106.82238625718091,-6.366740391778335],[106.8217141232146,-6.366135087934355],[106.8215308140501,-6.365903935986858],[106.82145197141364,-6.365745263799935],[106.8214421159044,-6.365717839207456],[106.8214322606977,-6.365443591093928],[106.82152292950728,-6.365228110451426],[106.82258074355968,-6.361813630190757],[106.82267765903862,-6.36156628675808],[106.82300577227879,-6.360561618247093],[106.82646484915253,-6.349295297042475],[106.82662961097681,-6.348881237733786],[106.82679056241071,-6.348645861184371],[106.82699060247094,-6.348504178797341],[106.82762980989762,-6.3481842494709815],[106.82781145521375,-6.348127118997285],[106.82814715428164,-6.348124834250687],[106.83132063747823,-6.348686589888224],[106.83161265009271,-6.348812276115519],[106.83179664735408,-6.348996564738525],[106.83189526988951,-6.3491492477541085],[106.83194268527521,-6.349399949471629],[106.83191423626853,-6.349586562107233],[106.83154951832383,-6.351188705704311],[106.83154951797322,-6.351352158746319],[106.83169725593977,-6.351778800340975],[106.8318143315671,-6.352011514222904],[106.83192304430808,-6.3524132211112905],[106.83190074442314,-6.353014397092337],[106.83166659344568,-6.354139174955968],[106.8315857556035,-6.354333102237226],[106.83034809932248,-6.355903909292467],[106.83026168792674,-6.356067360251776],[106.83020315015507,-6.356229155723879],[106.83019177056302,-6.35654017224898],[106.830222116269,-6.356738091801801],[106.83027522131749,-6.356883232821711],[106.83039281115632,-6.357058533052631],[106.83116913303435,-6.358062508867046],[106.83121275452656,-6.358205763954129],[106.83183145727551,-6.362196287857281],[106.83188835612688,-6.362686369678626],[106.83196611676709,-6.363206608337798],[106.83214819087186,-6.364137759619623],[106.83218612295519,-6.364463850705876],[106.83219370944018,-6.364786171822743],[106.83213870806277,-6.367655009436075],[106.83210077593748,-6.3678076870555405],[106.83121505931135,-6.368703017072651],[106.83109936601988,-6.368848154853232],[106.83104626118912,-6.369117695630399],[106.83100074261294,-6.36989615967564],[106.83097987993587,-6.370508751524728],[106.8309191884381,-6.370763212744939],[106.83077125307008,-6.371013903735322],[106.8305588327837,-6.371238206455704],[106.82989312322047,-6.371645343487923],[106.82972242824667,-6.3716736168969215],[106.82857118742204,-6.37164157346438],[106.82777650791444,-6.371628379021292],[106.82754701861623,-6.371581257070012],[106.82722649165235,-6.371360724174208],[106.82532988352169,-6.3693231498366885],[106.82509849740109,-6.369027220068561],[106.82502263320343,-6.368752024143348],[106.8249922870877,-6.3685428002266695],[106.82497901093811,-6.367234674795403],[106.82495625163756,-6.367144199176982],[106.82480641967074,-6.367000946073418],[106.82462434540332,-6.366929319410343],[106.82419950519345,-6.366934973541951],[106.8242222638335,-6.367734175163849],[106.82436830225195,-6.370610536458855],[106.82441571783855,-6.370678392243527],[106.82441761492113,-6.371102493717312],[106.82441002835097,-6.371366379045477],[106.82443089088757,-6.371654768165203]],C=[[106.831697,-6.351814],[106.831863,-6.352137],[106.83192,-6.352489],[106.831879,-6.352952],[106.831673,-6.354154],[106.830275,-6.355982],[106.830157,-6.356449],[106.830284,-6.356934],[106.831209,-6.358163],[106.831871,-6.362697],[106.831955,-6.363241],[106.832169,-6.364361],[106.83218,-6.364643],[106.832126,-6.367669],[106.832097,-6.367791],[106.832024,-6.367906],[106.831142,-6.36877],[106.831072,-6.368884],[106.830954,-6.370622],[106.8309,-6.370801],[106.830509,-6.371273],[106.829755,-6.371675],[106.827644,-6.371609],[106.827234,-6.371366],[106.825107,-6.369023],[106.825008,-6.368711],[106.824992,-6.367202],[106.824868,-6.367021],[106.824643,-6.366925],[106.824187,-6.366933],[106.824361,-6.370596],[106.824404,-6.370686],[106.824423,-6.371635],[106.824062,-6.371653],[106.824007,-6.371604],[106.823978,-6.371159],[106.823978,-6.371159],[106.823942,-6.370263],[106.824207,-6.370237],[106.824042,-6.366937],[106.822922,-6.366918],[106.822439,-6.36677],[106.821538,-6.365893],[106.821445,-6.36546],[106.821978,-6.36384],[106.822061,-6.363858],[106.821599,-6.365354],[106.821573,-6.365646],[106.82167,-6.365879],[106.822449,-6.366674],[106.822984,-6.366843],[106.824922,-6.36686],[106.825128,-6.367109],[106.825088,-6.368654],[106.825182,-6.368965],[106.827334,-6.37131],[106.827731,-6.371536],[106.829861,-6.371583],[106.830465,-6.371206],[106.830775,-6.370821],[106.830884,-6.370522],[106.830933,-6.369008],[106.831022,-6.368784],[106.831985,-6.367819],[106.832055,-6.367664],[106.832105,-6.364487],[106.831961,-6.363674],[106.831781,-6.363386],[106.831666,-6.36301],[106.831655,-6.362749],[106.831768,-6.36241],[106.831079,-6.358165],[106.831009,-6.357987],[106.830148,-6.356843],[106.830076,-6.356521],[106.830124,-6.356134],[106.830258,-6.355881],[106.831477,-6.354294],[106.831595,-6.354008],[106.831837,-6.352601],[106.831831,-6.352337],[106.831649,-6.351833],[106.831697,-6.351814]],g=new maplibregl.LngLatBounds;A.forEach(e=>g.extend(e));C.forEach(e=>g.extend(e));function W(e,i,o,a){const t=(o-e)*Math.PI/180,c=(a-i)*Math.PI/180,d=Math.sin(t/2)*Math.sin(t/2)+Math.cos(e*Math.PI/180)*Math.cos(o*Math.PI/180)*Math.sin(c/2)*Math.sin(c/2);return 6371*(2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)))}function G(e,i){const o=i&&i>5?i:20,a=e/o;return Math.ceil(a*60)}function U(e){if(e<=0)return"Tiba sekarang";if(e===1)return"1 min";if(e>=60){const i=Math.floor(e/60),o=e%60;return`${i} jam ${o} min`}return`${e} min`}const E={};let b=600,z=5;function q(e){e.gasAlertThreshold&&(b=e.gasAlertThreshold),e.busStopTimeoutMinutes&&(z=e.busStopTimeoutMinutes)}function T(e){const i=Date.now();if(e.speed>0)return E[e.bus_id]=i,{status:"Berjalan",class:"dot-green",icon:"fa-bus"};if(!E[e.bus_id])return{status:"Parkir",class:"dot-gray",icon:"fa-square-parking"};const o=E[e.bus_id];return(i-o)/1e3/60>=z?{status:"Parkir",class:"dot-gray",icon:"fa-square-parking"}:{status:"Berhenti",class:"dot-yellow",icon:"fa-circle-pause"}}let l,w={},$=[],D=null;function S(){const e=window.innerWidth,i=window.matchMedia("(orientation: landscape) and (max-height: 600px)").matches,o=e>=768;return i?{top:20,bottom:20,left:340,right:90}:o?{top:40,bottom:130,left:40,right:40}:{top:40,bottom:230,left:20,right:20}}function m(){return l}function y(e){D=e}function h(){return D}function j(){Object.values(w).forEach(e=>{const i=e.marker.getPopup();i&&i.remove()})}function V(){return l=new maplibregl.Map({container:"map",style:{version:8,glyphs:"https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",sources:{"google-maps":{type:"raster",tiles:[`https://mt0.google.com/vt/lyrs=m${window.devicePixelRatio>1?"&scale=2":""}&hl=id&x={x}&y={y}&z={z}`,`https://mt1.google.com/vt/lyrs=m${window.devicePixelRatio>1?"&scale=2":""}&hl=id&x={x}&y={y}&z={z}`,`https://mt2.google.com/vt/lyrs=m${window.devicePixelRatio>1?"&scale=2":""}&hl=id&x={x}&y={y}&z={z}`,`https://mt3.google.com/vt/lyrs=m${window.devicePixelRatio>1?"&scale=2":""}&hl=id&x={x}&y={y}&z={z}`],tileSize:256,attribution:"&copy; Google Maps"}},layers:[{id:"google-maps-layer",type:"raster",source:"google-maps",minzoom:0,maxzoom:22}]},bounds:g,maxBounds:[[g.getSouthWest().lng-.05,g.getSouthWest().lat-.05],[g.getNorthEast().lng+.05,g.getNorthEast().lat+.05]],fitBoundsOptions:{padding:S()},padding:S(),pitch:0,bearing:0,antialias:!0,maxZoom:18,minZoom:13}),l.on("load",()=>{K(l),setTimeout(()=>{l.resize(),l.fitBounds(g,{padding:S(),animate:!1})},500)}),window.addEventListener("resize",()=>{if(l){const e=S();l.setPadding(e)}}),l.on("styleimagemissing",e=>{const i=e.id;if(!l.hasImage(i)){const o=new Uint8Array(4);o[0]=0,o[1]=0,o[2]=0,o[3]=0,l.addImage(i,{width:1,height:1,data:o})}}),l.on("error",e=>{e.error&&e.error.message&&e.error.message.includes("Expected value to be of type number, but found null")||console.warn("Map error:",e.error)}),l}function J(){l.getSource("rutePagi")||(l.addSource("rutePagi",{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:A}}}),l.addLayer({id:"rutePagiLayer",type:"line",source:"rutePagi",layout:{"line-join":"round","line-cap":"round",visibility:"visible"},paint:{"line-color":"#BF1E2E","line-width":6,"line-opacity":.8,"line-offset":-3}}),l.addLayer({id:"rutePagiArrows",type:"symbol",source:"rutePagi",layout:{"icon-image":"arrow","symbol-placement":"line","symbol-spacing":50,"icon-allow-overlap":!0,"icon-ignore-placement":!0,"icon-size":.6,"icon-offset":[0,-4],visibility:"visible","icon-rotation-alignment":"map"},paint:{"icon-opacity":.9,"icon-color":"#ffffff"}})),l.getSource("ruteSore")||(l.addSource("ruteSore",{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:C}}}),l.addLayer({id:"ruteSoreLayer",type:"line",source:"ruteSore",layout:{"line-join":"round","line-cap":"round",visibility:"visible"},paint:{"line-color":"#159BB3","line-width":6,"line-opacity":.8,"line-offset":3}}),l.addLayer({id:"ruteSoreArrows",type:"symbol",source:"ruteSore",layout:{"icon-image":"arrow","symbol-placement":"line","symbol-spacing":50,"icon-allow-overlap":!0,"icon-ignore-placement":!0,"icon-size":.6,"icon-offset":[0,4],visibility:"visible","icon-rotation-alignment":"map"},paint:{"icon-opacity":.9,"icon-color":"#ffffff"}})),document.querySelectorAll(".chip").forEach(e=>e.classList.add("active-route"))}function K(e){const i=document.createElement("canvas");i.width=24,i.height=24;const o=i.getContext("2d");o.beginPath(),o.moveTo(6,4),o.lineTo(16,12),o.lineTo(6,20),o.lineWidth=4,o.strokeStyle="#ffffff",o.lineCap="round",o.lineJoin="round",o.stroke(),e.addImage("arrow",{width:24,height:24,data:o.getImageData(0,0,24,24).data});const a=document.createElement("canvas");a.width=32,a.height=32;const s=a.getContext("2d");s.beginPath(),s.arc(16,16,13,0,Math.PI*2),s.fillStyle="#ffffff",s.fill(),s.lineWidth=3,s.strokeStyle="#0f172a",s.stroke(),s.fillStyle="#0f172a",s.beginPath(),s.roundRect(9,9,14,14,2),s.fill(),s.fillStyle="#ffffff",s.fillRect(11,11,10,5),s.fillStyle="#0f172a",s.beginPath(),s.arc(11,24,1.5,0,Math.PI*2),s.arc(21,24,1.5,0,Math.PI*2),s.fill(),e.addImage("stop-icon",{width:32,height:32,data:s.getImageData(0,0,32,32).data})}function N(e,i){if(!l)return;const o=e+"Layer",a=l.getLayoutProperty(o,"visibility"),s=a==="visible"||a===void 0?"none":"visible";l.setLayoutProperty(o,"visibility",s);const t=o.replace("Layer","Arrows");l.getLayer(t)&&l.setLayoutProperty(t,"visibility",s);const c=s==="visible";if(i&&((i.classList.contains("chip")||i.classList.contains("chip-dashboard"))&&i.classList.toggle("active-route",c),i.classList.contains("route-card-item")&&i.classList.toggle("active-card",c),!i.classList.contains("chip-dashboard"))){const d=i.querySelector("i");d&&(d.className=c?"fa-solid fa-check":"fa-solid fa-xmark")}}typeof window<"u"&&(window.toggleRoute=N);function Z(){$.forEach(i=>i.remove()),$=[];const e={type:"FeatureCollection",features:I.map(i=>({type:"Feature",geometry:{type:"Point",coordinates:[i.lng,i.lat]},properties:{title:i.title.replace("Halte ",""),fullName:i.title}}))};if(l.getSource("stopsSource"))l.getSource("stopsSource").setData(e);else{l.addSource("stopsSource",{type:"geojson",data:e}),l.addLayer({id:"stopsIcons",type:"symbol",source:"stopsSource",layout:{"icon-image":"stop-icon","icon-size":1,"icon-allow-overlap":!0,"icon-ignore-placement":!0}}),l.addLayer({id:"stopsLabels",type:"symbol",source:"stopsSource",minzoom:14.5,layout:{"text-field":["get","title"],"text-font":["Open Sans Bold"],"text-size":12,"text-offset":[0,2],"text-anchor":"top","text-allow-overlap":!1},paint:{"text-color":"#334155","text-halo-color":"#ffffff","text-halo-width":2}});const i=new maplibregl.Popup({closeButton:!1,closeOnClick:!1,offset:15});l.on("mouseenter","stopsIcons",o=>{l.getCanvas().style.cursor="pointer";const a=o.features[0].geometry.coordinates.slice(),s=o.features[0].properties.fullName;i.setLngLat(a).setText(s).addTo(l)}),l.on("mouseleave","stopsIcons",()=>{l.getCanvas().style.cursor="",i.remove()}),l.on("click","stopsIcons",o=>{const a=o.features[0].geometry.coordinates.slice();l.flyTo({center:a,zoom:16})})}}function Q(){const e=l.getStyle();if(!e||!e.sources)return;const i=Object.keys(e.sources).find(o=>e.sources[o].type==="vector");i&&!l.getLayer("add-3d-buildings")&&l.addLayer({id:"add-3d-buildings",source:i,"source-layer":"building",filter:["all",["has","extrude"],["==",["get","extrude"],"true"]],type:"fill-extrusion",minzoom:14,paint:{"fill-extrusion-color":"#aaa","fill-extrusion-height":["case",["has","render_height"],["to-number",["get","render_height"],0],["has","height"],["to-number",["get","height"],0],0],"fill-extrusion-base":["case",["has","render_min_height"],["to-number",["get","render_min_height"],0],["has","min_height"],["to-number",["get","min_height"],0],0],"fill-extrusion-opacity":.6}})}function H(e){const i=[e.longitude,e.latitude],o=e.gas_level>b?"popup-danger":"",s=T(e).status;let t="status-stopped";s==="Berjalan"?t="status-moving":s==="Berhenti"&&(t="status-paused");let c="";const n=I.map(r=>({...r,dist:W(e.latitude,e.longitude,r.lat,r.lng)})).sort((r,u)=>r.dist-u.dist)[0];if(n&&n.dist<5){const r=G(n.dist,e.speed);c=`
        <div class="popup-eta" style="margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
            <div style="font-size:0.75rem; color:#6b7280; display:flex; justify-content:space-between; align-items:center;">
                <span>Menuju <b>${n.title.replace("Halte ","")}</b></span>
                <span style="background:#e0f2fe; color:#0369a1; padding:2px 6px; border-radius:4px; font-weight:700;">${U(r)}</span>
            </div>
            <div style="width:100%; height:4px; background:#f3f4f6; border-radius:2px; margin-top:6px; overflow:hidden;">
                <div style="width:${Math.max(10,Math.min(100,(1-n.dist/3)*100))}%; height:100%; background:#0369a1; border-radius:2px;"></div>
            </div>
        </div>`,X(e,n)}const p=`
        <div class="bus-popup">
            <div class="popup-header">
                <img src="./images/bipol.png" class="popup-icon">
                <div class="popup-title">
                    <h3>${e.bus_id}</h3>
                    <div style="display:flex; gap:6px; align-items:center;">
                        <span class="popup-status ${t}" style="font-size:0.7rem; padding:2px 6px;">${s}</span>
                    </div>
                </div>
            </div>
            <div class="popup-stats">
                <div class="popup-stat">
                    <i class="fa-solid fa-gauge"></i>
                    <span>${e.speed} km/h</span>
                </div>
                <div class="popup-stat ${o}">
                    <i class="fa-solid fa-fire"></i>
                    <span>${e.gas_level}</span>
                </div>
            </div>
            ${c}
        </div>
    `;if(w[e.bus_id]){const r=w[e.bus_id];if(r.marker.setLngLat(i),r.marker.getPopup().setHTML(p),h()===e.bus_id&&m()){const u=m(),f=u.getMaxBounds();(!f||f.contains(i))&&u.jumpTo({center:i})}}else{const r=document.createElement("div");r.className="bus-marker-icon",r.style.backgroundImage="url(/images/bipol.png)",r.style.width="42px",r.style.height="42px",r.style.backgroundSize="contain",r.style.backgroundRepeat="no-repeat",r.style.cursor="pointer";const u=document.createElement("div");u.className="marker-pulse",r.appendChild(u),r.onclick=()=>{if(h()===e.bus_id)return;const L=m();if(L){const v=L.getMaxBounds();if(v&&!v.contains(i)){typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Bus Diluar Area",text:"Posisi bus berada di luar jangkauan peta.",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});return}y(e.bus_id),L.jumpTo({center:i,zoom:17.5}),document.querySelectorAll(".bus-item").forEach(F=>F.classList.remove("active-focus"))}};const f=new maplibregl.Marker({element:r}).setLngLat(i).setPopup(new maplibregl.Popup({offset:20,anchor:"bottom"}).setHTML(p)).addTo(l);w[e.bus_id]={marker:f}}}const x=new Map;function X(e,i){if(i.dist>.25)return;const o=`${e.bus_id}-${i.title}`,a=Date.now(),s=300*1e3;if(!(x.has(o)&&a-x.get(o)<s)&&(Y(e,i),x.set(o,a),x.size>50))for(const[t,c]of x)a-c>s&&x.delete(t)}function Y(e,i){const o=document.getElementById("arrival-notification-container");if(!o)return;const a=document.createElement("div");a.className="arrival-card";const s=i.title.replace("Halte ","");a.innerHTML=`
        <div class="arrival-icon">
            <img src="/images/bipol.png" style="width:100%; height:100%; object-fit:contain;">
        </div>
        <div class="arrival-content">
            <h4>${e.bus_id} Mendekat!</h4>
            <p>Akan tiba di ${s}</p>
        </div>
        <div class="arrival-time">
            <i class="fa-solid fa-clock"></i> Segera
        </div>
    `,o.appendChild(a),setTimeout(()=>{a.classList.add("leaving"),a.addEventListener("animationend",()=>{a.remove()})},6e3)}function ee(e){Object.keys(w).forEach(i=>{e.has(i)||(w[i].marker.remove(),delete w[i])})}let _=0;fetch("/api/config").then(e=>e.json()).then(e=>{q(e)}).catch(()=>{});function te(){document.getElementById("recenterBtn").onclick=()=>{if(y(null),j(),m().fitBounds(g,{padding:S(),pitch:0,bearing:0,speed:1.2,curve:1.42,essential:!0}),document.querySelectorAll(".bus-item").forEach(i=>i.classList.remove("active-focus")),window.innerWidth<768){const i=document.querySelector(".bottom-sheet");i&&i.classList.add("collapsed")}},window.toggleRouteCard=i=>{N(i,null)};const e=document.getElementById("toggleSheetBtn");if(e&&e.addEventListener("click",i=>{i.stopPropagation(),document.querySelector(".bottom-sheet").classList.toggle("collapsed")}),window.innerWidth<768){const i=document.querySelector(".bottom-sheet");i&&i.classList.add("collapsed")}window.addEventListener("online",()=>{typeof Swal<"u"&&Swal.fire({toast:!0,position:"top-end",icon:"success",title:"Online Kembali",showConfirmButton:!1,timer:3e3})}),window.addEventListener("offline",()=>{typeof Swal<"u"&&Swal.fire({toast:!0,position:"top-end",icon:"warning",title:"Koneksi Terputus",text:"Beralih ke mode offline",showConfirmButton:!1,timer:5e3})})}function ie(e,i,o){const a=document.createElement("div");a.className="bus-item animate-enter",a.style.animationDelay=`${o*.1}s`,a.id=`bus-item-${e.bus_id}`,h()===e.bus_id&&a.classList.add("active-focus");const s=T(e);let t=s.class;e.gas_level>b&&(t="dot-red");const c=e.gas_level>b?"text-danger":"",d=k(e);a.innerHTML=`
        <div class="bus-icon-wrapper"><img src="./images/bipol.png"></div>
        <div class="bus-info">
            <h4>${e.bus_id} <span class="status-dot ${t}"></span> <span class="eta-inline"><i class="fa-solid ${d.icon}"></i> ${d.text}</span></h4>
            <p><span><i class="fa-solid ${s.icon}"></i> ${s.status}</span> &bull;
            <span><i class="fa-solid fa-gauge"></i> ${e.speed} km/h</span> &bull;
            <span class="${c}"><i class="fa-solid fa-fire"></i> ${e.gas_level}</span></p>
        </div>`,a.onclick=()=>{if(h()===e.bus_id)return;const n=m();if(n){const p=n.getMaxBounds();if(p&&!p.contains([e.longitude,e.latitude])){Swal.fire({icon:"warning",title:"Bus Diluar Area",text:"Posisi bus berada di luar jangkauan peta.",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});return}if(y(e.bus_id),n.flyTo({center:[e.longitude,e.latitude],zoom:18,speed:1.5,curve:1}),document.querySelectorAll(".bus-item").forEach(r=>r.classList.remove("active-focus")),window.innerWidth<768){const r=document.querySelector(".bottom-sheet");r&&r.classList.add("collapsed")}a.classList.add("active-focus")}},i.appendChild(a)}function k(e){const i=B.point([e.longitude,e.latitude]);let o=1/0,a="";I.forEach(t=>{const c=B.point([t.lng,t.lat]),d=B.distance(i,c,{units:"kilometers"});d<o&&(o=d,a=t.title)});const s=e.speed&&e.speed>1?e.speed:20;return o<.05?{text:`Tiba di ${a}`,icon:"fa-check-circle",arrived:!0}:{text:`${Math.ceil(o/s*60)} min ke ${a}`,icon:"fa-clock",arrived:!1}}function O(e){e.gas_level>b&&Date.now()-_>3e4&&(Swal.fire({html:`
                <div class="gas-warning-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
                <div class="gas-alert-title">GAS TINGGI DETEKSI</div>
                <div class="gas-value-display">${e.gas_level}</div>
                <div class="gas-alert-text">Segera periksa kondisi armada ${e.bus_id}</div>
            `,showConfirmButton:!0,confirmButtonText:"MENGERTI",confirmButtonColor:"#BF1E2E",background:"transparent",customClass:{popup:"gas-alert-popup"},backdrop:"rgba(191,30,46,0.2)"}),_=Date.now())}let P="home";function oe(e){e===P&&e!=="home"&&(e="home"),P=e,document.querySelectorAll(".nav-item").forEach(c=>c.classList.remove("active"));const i=document.querySelector(`.nav-item[onclick*="'${e}'"]`);i&&i.classList.add("active");const o=document.querySelector(".bottom-sheet"),a=document.getElementById("info-page"),s=document.getElementById("faq-page"),t=document.getElementById("route-view");e==="home"?(o.classList.remove("hidden"),a.classList.remove("active-page"),s.classList.remove("active-page"),t.classList.remove("active-page"),t.classList.remove("closing"),h()&&(y(null),document.querySelectorAll(".bus-item").forEach(c=>c.classList.remove("active-focus"))),j(),m()&&m().fitBounds(g,{padding:S(),speed:1.2,curve:1.42,essential:!0}),window.innerWidth<768&&o.classList.add("collapsed")):e==="map"?(o.classList.add("hidden"),a.classList.remove("active-page"),s.classList.remove("active-page"),t.classList.add("active-page"),m().resize(),m().fitBounds(g,{padding:{top:20,bottom:80,left:20,right:20},speed:.8,curve:1.2})):e==="announcement"?(o.classList.add("hidden"),t.classList.remove("active-page"),s.classList.remove("active-page"),a.classList.add("active-page")):e==="faq"&&(o.classList.add("hidden"),t.classList.remove("active-page"),a.classList.remove("active-page"),s.classList.add("active-page"),se())}async function se(){const e=document.getElementById("busPlate");if(e&&!(e.options.length>1))try{(await(await fetch("/api/bus-plates")).json()).forEach(a=>{const s=document.createElement("option");s.value=a,s.textContent=a,e.appendChild(s)})}catch(i){console.error(i)}}function ae(e){const i=document.getElementById("image-modal"),o=document.getElementById("img01");i.style.display="block",o.src=e}function R(){const e=document.getElementById("image-modal");e.style.display="none"}window.switchTab=oe;window.viewImage=ae;window.closeImage=R;fetch("/api/config").then(e=>e.json()).then(e=>{q(e)}).catch(()=>{});const M=V();M.on("load",()=>{J();try{Q()}catch{}Z();const e=()=>{const t=document.getElementById("loading-screen");t&&!t.classList.contains("hidden")&&t.classList.add("hidden")};setTimeout(e,300),setTimeout(e,3e3);const i=document.getElementById("skeleton-loader"),o=document.getElementById("empty-state");i&&i.classList.remove("hidden"),o&&(o.style.display="none");const a=io({connectionStateRecovery:{maxDisconnectionDuration:120*1e3,skipMiddlewares:!0},reconnectionDelay:1e3,reconnectionDelayMax:5e3}),s=t=>{H(t);const c=document.getElementById("bus-list"),d=document.getElementById(`bus-item-${t.bus_id}`);if(d){const n=T(t);let p=n.class;t.gas_level>b&&(p="dot-red");const r=t.gas_level>b?"text-danger":"",u=k(t);d.innerHTML=`
                <div class="bus-icon-wrapper"><img src="./images/bipol.png"></div>
                <div class="bus-info">
                    <h4>${t.bus_id} <span class="status-dot ${p}"></span> <span class="eta-inline"><i class="fa-solid ${u.icon}"></i> ${u.text}</span></h4>
                    <p><span><i class="fa-solid ${n.icon}"></i> ${n.status}</span> &bull;
                    <span><i class="fa-solid fa-gauge"></i> ${t.speed} km/h</span> &bull;
                    <span class="${r}"><i class="fa-solid fa-fire"></i> ${t.gas_level}</span></p>
                </div>`,d.onclick=()=>{if(h()===t.bus_id)return;const f=m();if(f){const L=f.getMaxBounds();if(L&&!L.contains([t.longitude,t.latitude])){typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Bus Diluar Area",text:"Posisi bus berada di luar jangkauan peta.",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});return}if(y(t.bus_id),f.flyTo({center:[t.longitude,t.latitude],zoom:18,speed:1.5}),document.querySelectorAll(".bus-item").forEach(v=>v.classList.remove("active-focus")),window.innerWidth<768){const v=document.querySelector(".bottom-sheet");v&&v.classList.add("collapsed")}d.classList.add("active-focus")}}}else{const n=document.createElement("div");n.className="bus-item",n.id=`bus-item-${t.bus_id}`;let p=t.speed<1?"dot-gray":"dot-green";n.innerHTML=`
                <div class="bus-icon-wrapper"><img src="./images/bipol.png"></div>
                <div class="bus-info">
                    <h4>${t.bus_id} <span class="status-dot ${p}"></span></h4>
                    <p><span><i class="fa-solid fa-gauge"></i> ${t.speed} km/h</span> &bull;
                    <span><i class="fa-solid fa-fire"></i> ${t.gas_level}</span></p>
                </div>`,n.onclick=()=>{if(h()===t.bus_id)return;const r=m();if(r){const u=r.getMaxBounds();if(u&&!u.contains([t.longitude,t.latitude])){typeof Swal<"u"&&Swal.fire({icon:"warning",title:"Bus Diluar Area",text:"Posisi bus berada di luar jangkauan peta.",toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3});return}if(y(t.bus_id),r.flyTo({center:[t.longitude,t.latitude],zoom:17.5}),document.querySelectorAll(".bus-item").forEach(f=>f.classList.remove("active-focus")),window.innerWidth<768){const f=document.querySelector(".bottom-sheet");f&&f.classList.add("collapsed")}n.classList.add("active-focus")}},c.appendChild(n)}if(k(t),O(t),h()===t.bus_id){const n=m();if(n){const p=n.getMaxBounds();(!p||p.contains([t.longitude,t.latitude]))&&n.flyTo({center:[t.longitude,t.latitude],speed:.5})}}document.getElementById("skeleton-loader").classList.add("hidden"),document.getElementById("empty-state").classList.add("hidden"),document.getElementById("empty-state").style.display="none"};a.on("update_bus",s),M.on("dragstart",()=>{y(null);const t=document.querySelector(".maplibregl-popup");t&&t.remove()}),M.on("touchmove",()=>{y(null);const t=document.querySelector(".maplibregl-popup");t&&t.remove()})});te();document.addEventListener("keydown",function(e){e.key==="Escape"&&R()});async function ne(){try{const o=(await(await fetch("/api/bus/location")).json()).data||[],a=document.getElementById("bus-list"),s=document.getElementById("skeleton-loader"),t=document.getElementById("empty-state");if(s.classList.add("hidden"),s.style.display="none",o.length===0){t.style.display="flex",t.classList.remove("hidden"),Array.from(a.children).forEach(n=>{!n.classList.contains("skeleton-loader")&&!n.classList.contains("empty-state")&&n.remove()});return}else t.style.display="none",t.classList.add("hidden");Array.from(a.children).forEach(n=>{!n.classList.contains("skeleton-loader")&&!n.classList.contains("empty-state")&&n.remove()});const c=new Set;o.forEach((n,p)=>{if(c.add(n.bus_id),H(n),ie(n,a,p),k(n),O(n),h()===n.bus_id){const r=m();if(r){const u=r.getMaxBounds();(!u||u.contains([n.longitude,n.latitude]))&&r.flyTo({center:[n.longitude,n.latitude],speed:.5})}}});const d=document.getElementById("collapsed-summary");d&&(d.innerHTML=`<i class="fa-solid fa-bus"></i> ${c.size} Armada Aktif`),ee(c)}catch{}}async function le(){try{const i=await(await fetch("/api/info")).json(),o=document.getElementById("dynamic-info-list");if(!o)return;o.innerHTML="";const a=document.createElement("div");a.className="info-card",a.innerHTML=`
            <div class="info-icon"><i class="fa-solid fa-box-open"></i></div>
            <div class="info-text">
                <div style="font-size:0.75em; color:#64748b; margin-bottom:4px; font-weight:500;">
                    <i class="fa-solid fa-thumbtack" style="transform:rotate(45deg); margin-right:4px;"></i> Tersemat
                </div>
                <h4>Barang Ketinggalan?</h4>
                <p>Lapor segera melalui fitur lost & found kami.</p>
                <button onclick="goToLostItems()" style="margin-top:10px; background:var(--accent); color:white; border:none; padding:8px 16px; border-radius:8px; font-size:0.8rem; cursor:pointer; font-weight:500; display:inline-flex; align-items:center; gap:6px;">
                    Lapor Sekarang <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        `,o.appendChild(a);const s=document.createElement("div");if(s.className="info-card",s.innerHTML=`
            <div class="info-icon"><i class="fa-solid fa-code"></i></div>
            <div class="info-text">
                <div style="font-size:0.75em; color:#64748b; margin-bottom:4px; font-weight:500;">
                    <i class="fa-solid fa-thumbtack" style="transform:rotate(45deg); margin-right:4px;"></i> Tersemat
                </div>
                <h4>Temukan Bug / Saran?</h4>
                <p>Bantu kami kembangkan aplikasi ini jadi lebih baik.</p>
                <button onclick="goToFeedback()" style="margin-top:10px; background:#475569; color:white; border:none; padding:8px 16px; border-radius:8px; font-size:0.8rem; cursor:pointer; font-weight:500; display:inline-flex; align-items:center; gap:6px;">
                    Beri Masukan <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        `,o.appendChild(s),window.goToLostItems=function(){window.switchTab&&window.switchTab("faq"),setTimeout(()=>{const t=document.querySelector(".lost-items-section");t&&t.scrollIntoView({behavior:"smooth",block:"center"})},100)},window.goToFeedback=function(){window.switchTab&&window.switchTab("faq"),setTimeout(()=>{const t=document.querySelector(".feedback-section");t&&t.scrollIntoView({behavior:"smooth",block:"center"})},100)},i.length===0)return;i.forEach(t=>{const c=new Date(t.created_at).toLocaleDateString("id-ID",{day:"numeric",month:"short",hour:"2-digit",minute:"2-digit"}),d=document.createElement("div");d.className="info-card",d.innerHTML=`
                <div class="info-icon"><i class="fa-solid fa-bullhorn"></i></div>
                <div class="info-text">
                    <h4>${t.title}</h4>
                    <p>${t.content}</p>
                    <div style="font-size:0.75em; color:#888; margin-top:5px;"><i class="fa-regular fa-clock"></i> ${c}</div>
                </div>
            `,o.appendChild(d)})}catch{}}ne();le();
